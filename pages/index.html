<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title i18n="title">黑幕叠加视频</title>
    <link rel="stylesheet" href="./css/layui.css">
    <script src="./js/layui.js"></script>
    <script src="./js/web.min.js"></script>
    <script src="./js/html.js"></script>
    <script src="./js/jquery-3.6.0.min.js"></script>
    <script src="./js/GPXParser.js"></script>
    <script src="./js/TCXParser.js"></script>
    <script src="./js/bf-backfit.js"></script>
    <script src="./js/svg.js"></script>
    <script src="./js/i18n.js"></script>
    <link rel="stylesheet" href="./css/maptalks.css">
    <script src="./js/maptalks.min.js"></script>
    <script src="./js/mp4-muxer.js"></script>



    <style>
        html,
        body {
            height: 100%;
            /* 设置html和body的高度为100% */
            margin: 0;
            /* 移除默认的margin */
            padding: 0;
            /* 移除默认的padding */
        }

        .layui-container {
            width: 100%;
            height: calc(100% - 40px);
            /* 设置容器高度为100% */
            overflow: hidden;
        }

        .layui-row {
            height: 100%;
            /* 设置行的高度为100% */
            margin: 0;
        }

        .column {
            float: left;
            height: 100%;
            /* 设置列的高度为100% */
        }

        .column1,
        .column3 {
            width: 270px;
            background-color: #f2f2f2;
            overflow-y: auto;
        }

        .column2 {
            width: calc(100% - 540px);
            /* 减去第1列和第3列的宽度 */
            overflow: auto;
            background-color: #ddd;
        }


        .layui-nav {
            position: relative;
            padding: 0 15px;
            background-color: #ffffff;
            color: #000000;
            font-size: 0;
            box-sizing: border-box;
        }

        .layui-nav .layui-nav-item {
            position: relative;
            display: inline-block;
            margin-top: 0;
            list-style: none;
            vertical-align: middle;
            line-height: 40px;
        }

        #c {
            width: 100%;
            height: 100%;
        }

        meter::-webkit-meter-optimum-value {
            box-shadow: 0 5px 5px -5px #999 inset;
            background-image: linear-gradient(90deg,
                    #8bcf69 5%,
                    #e6d450 5%,
                    #e6d450 15%,
                    #f28f68 15%,
                    #f28f68 55%,
                    #cf82bf 55%,
                    #cf82bf 95%,
                    #719fd1 95%,
                    #719fd1 100%);
            background-size: 100% 100%;
        }

        /* 可以在这里添加一些自定义样式，比如调整方块的大小等 */
        .b169 {
            background: #fff;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid black;
            width: 90px;
            height: 50px;
            line-height: 50px;
            text-align: center;
            margin-top: 30px;
            margin-bottom: 10px;
        }

        .b196 {
            background: #fff;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid black;
            width: 50px;
            height: 90px;
            line-height: 100px;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .view {
            position: relative;
            width: 720px;
            /* 设置与video相同的宽度 */
            height: 720px;
            /* 设置与video相同的高度 */
        }

        .view_info {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            /* 使其与父元素.view的宽度一致 */
            height: 100%;
            /* 使其与父元素.view的高度一致 */
            display: flex;
            justify-content: center;
            /* 水平居中 */
            align-items: center;
            /* 垂直居中 */
            background: rgba(0, 0, 0, 0.5);
            /* 半透明背景 */
            color: white;
            /* 文字颜色 */
            font-size: 48px;
            /* 文字大小 */
            z-index: 10;
            /* 确保叠加在video之上 */
        }

        video {
            width: 100%;
            /* 使video充满.view容器 */
            height: 100%;
            /* 使video充满.view容器 */
            z-index: 1;
            /* 确保video在.view_info之下 */
        }

        .time {
            margin-top: 10px;
            font-size: 16px;
        }

        .download_button {
            margin-left: auto;
            margin-right: auto;
        }

        #progressBar {
            width: 80%;
            /* 进度条宽度，可根据需要调整 */
            cursor: pointer;
            /* 鼠标悬停时显示指针，表示可拖动 */
            -webkit-appearance: none;
            /* 去除默认样式 */
            appearance: none;
            height: 10px;
            /* 进度条高度 */
            background: #ddd;
            /* 进度条背景颜色 */
            outline: none;
            /* 去除聚焦时的轮廓线 */
            opacity: 0.7;
            /* 进度条透明度 */
        }

        #progressBar::-webkit-slider-thumb {
            -webkit-appearance: none;
            /* 去除默认样式 */
            appearance: none;
            width: 25px;
            /* 滑块宽度 */
            height: 25px;
            /* 滑块高度 */
            background: #4CAF50;
            /* 滑块颜色 */
            cursor: pointer;
            /* 鼠标悬停时显示指针 */
            border-radius: 50%;
            /* 滑块形状为圆形 */
        }

        #progressBar::-moz-range-thumb {
            width: 25px;
            /* 滑块宽度 */
            height: 25px;
            /* 滑块高度 */
            background: #4CAF50;
            /* 滑块颜色 */
            cursor: pointer;
            /* 鼠标悬停时显示指针 */
            border-radius: 50%;
            /* 滑块形状为圆形 */
        }

        /* 设置.tt类为自适应占据下方剩余空间 */
        /* 确保column1是一个flex容器 */
        .column.column1 {
            display: flex;
            /* 使用flex布局 */
            flex-direction: column;
            /* 子元素垂直排列 */
            height: 100%;
            /* 确保column1占据整个父容器的高度 */
        }

        /* 让.tt类占据剩余空间 */
        .tt {
            flex-grow: 1;
            /* 允许.tt扩展以占据剩余空间 */
            overflow: auto;
            /* 当内容超出时显示滚动条 */
            padding-top: 5px;
        }

        /* 内部列1添加四边边框 */
        .grid-demo-bg1 {
            border: 1px solid #CCC;
            /* 添加四边边框 */
            height: 100%;
        }

        /* 内部列2添加上、右、下边框 */
        .grid-demo-bg2 {
            border-top: 1px solid #CCC;
            /* 上边框 */
            border-right: 1px solid #CCC;
            /* 右边框 */
            border-bottom: 1px solid #CCC;
            /* 下边框 */
            overflow-y: auto;
            /* 当内容超出时显示滚动条 */
            height: 100%;
        }

        .demo-tab-header .tab {
            margin: 10px;
            text-align: center;
            border-bottom: 2px solid #CCC;
        }


        .demo-tab-header .tab.layui-this {
            border-color: #1E9FFF;
            color: #1E9FFF;
        }

        .demo-tab-header .tab .layui-this {

            color: #1E9FFF;
        }

        .iconcc {
            font-size: 30px;
        }

        .demo-tab-body>div {
            display: none;
        }

        .ws-docs-anim>div {
            padding: 16px;
            transition: all .3s;
        }

        .ws-docs-anim>div :hover {
            background-color: #ebfbbd;
            color: #000;
        }

        .ws-docs-anim>div .layui-anim {
            width: 125px;
            height: 125px;
            line-height: 125px;
            margin: 10px auto 10px;
            text-align: center;
            cursor: pointer;
            color: #fff;
            border-radius: 5%;
            user-select: none;
        }

        .ws-docs-anim>div .layui-anim img {
            border-radius: 5%;
        }

        .ws-docs-anim>div>div {
            text-align: center;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <div class="layui-nav">
        <li class="layui-nav-item" style="margin-right: 30px;font-size: 22px;" i18n="title">
            黑幕叠加视频
        </li>

        <li class="layui-nav-item" style="margin-right: 30px;font-size: 12px;">
            Beta 0.20
        </li>
        <li class="layui-nav-item" i18n="readme"></li>
        <div class="ws-header-menu">
            <li class="layui-nav-item" style="position: absolute;right: 240px;top: 0;">
                <button id="generate" class="layui-btn layui-btn-xs layui-btn-normal" lay-on="onmp4-page"
                    i18n="generate">生成MP4视频</button>

            </li>
            <li class="layui-nav-item"
                style="position: absolute;right: 200px;top: 0px;color: #000;width: 30px;text-align: center;"
                lay-on="setup">
                <i class="layui-icon layui-icon-set-fill" style="font-size: 18px; color: #000000;"></i>
            </li>
            <li class="layui-nav-item" style="position: absolute;right: 80px;top: 0px;color: #000;width: 100px;">
                <a href="javascript:;" style="color: #000000;"><i class="layui-icon layui-icon-website"
                        style="font-size: 18px; color: #000000;"></i><span id="language">中文</span></a>

                <dl class="layui-nav-child" style="top: 0px;">
                    <dd class="chinese">中文</dd>
                    <dd class="english">English</dd>
                    <dd class="Japanese">日本语</dd>
                    <dd class="Korean">한국어</dd>
                </dl>
            </li>
            <li class="layui-nav-item" style="position: absolute;right: 10px;top: 0px;color: #000;text-align: center;">
                <a href="https://github.com/dalang911/Web-Sport-Data-Overlay" target="_blank"><i
                        class="layui-icon layui-icon-github" style="font-size: 18px; color: #000000;"></i></a>
            </li>
        </div>
    </div>
    <div class="layui-container">
        <div class="layui-row">
            <div class="column column1">
                <input type="file" id="fileInput" class="layui-btn demo-class-accept -disabled" style="padding: 1px;"
                    accept=".json,.gpx,.tcx,.fit">
                <fieldset class="layui-elem-field">
                    <legend i18n="sportsinfo">运动信息</legend>
                    <div class="layui-field-box" id="jsonInfo">

                    </div>
                </fieldset>
                <div id="fast_button">

                </div>
                <!--组件框-->
                <div class="tt">

                    <div class="demo-tab-header layui-btn-container layui-col-md3 grid-demo-bg1" id="tabHeader">
                        <div class="layui-col-md12" style="text-align: center;margin-top: 5px;margin-bottom: 5px;"
                            i18n="dashboard">仪表盘
                        </div>
                        <div class="tab layui-btn-primary layui-this">
                            <i class="layui-icon layui-icon-log iconcc"></i>
                            <div class="docs-icon-name" i18n="dateandtime">时间</div>
                        </div>
                        <div class="tab layui-btn-primary"><i class="layui-icon layui-icon-next iconcc"></i>
                            <div class="docs-icon-name" i18n="distance">距离</div>
                        </div>
                        <div class="tab layui-btn-primary"><i class="layui-icon layui-icon-location iconcc"></i>
                            <div class="docs-icon-name" i18n="map">地图</div>
                        </div>
                        <div class="tab layui-btn-primary"><i class="layui-icon layui-icon-chart iconcc"></i>
                            <div class="docs-icon-name" i18n="chart">图表</div>
                        </div>
                        <div class="tab layui-btn-primary"><i class="layui-icon layui-icon-console iconcc"></i>
                            <div class="docs-icon-name" i18n="attribute">属性</div>
                        </div>
                        <div class="tab layui-btn-primary"><i class="layui-icon layui-icon-fonts-strong iconcc"></i>
                            <div class="docs-icon-name" i18n="text">文本</div>
                        </div>
                    </div>


                    <div class="demo-tab-body layui-col-md9 grid-demo-bg2 ws-docs-anim" id="tabBody">
                        <div></div>
                        <div class="layui-show">
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="appv_date_pan"><img src="./images/m1.png"></div>
                                <div i18n="dateandtime">日期时间</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="text_day_pan"><img src="./images/m2.png"></div>
                                <div i18n="date">日期</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="text_time_pan"><img src="./images/m3.png"></div>
                                <div i18n="time">时间</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="text_nowtime_pan"><img src="./images/m4.png"></div>
                                <div i18n="Elapsedtime">用时</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="appv_nowtime_pan"><img src="./images/m5.png"></div>
                                <div i18n="Elapsedtime">用时</div>
                            </div>
                        </div>
                        <div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="l_distance_pan"><img src="./images/l1.png"></div>
                                <div i18n="distancewide">距离长</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="appv_distance_pan"><img src="./images/l2.png"></div>
                                <div i18n="distance">距离</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="appv_ele_pan"><img src="./images/l3.png"></div>
                                <div i18n="elevation">高程</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="appv_ele18_pan"><img src="./images/l4.png"></div>
                                <div i18n="elevationwide">高程长</div>
                            </div>
                        </div>
                        <div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="appv_map_pan"><img src="./images/w1.png"></div>
                                <div i18n="route">轨迹</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="web_map_pan"><img src="./images/w3.png"></div>
                                <div i18n="webroute">轨迹</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="web_minimap_pan"><img src="./images/w4.png"></div>
                                <div i18n="webroute">轨迹</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="TO_gps_pan"><img src="./images/w2.png"></div>
                                <div i18n="location">位置</div>
                            </div>
                        </div>
                        <div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="appv_metrics_pan"><img src="./images/t1.png"></div>
                                <div i18n="Heart_pace_cadence">心率配速踏频</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="el_leida_pan"><img src="./images/t2.png"></div>
                                <div i18n="leida">雷达</div>
                            </div>
                        </div>
                        <div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="TO_pace_pan"><img src="./images/z1.png"></div>
                                <div i18n="pace">配速</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="TO_heart_pan"><img src="./images/z2.png"></div>
                                <div i18n="heart_rate">心率</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="TO_cadence_pan"><img src="./images/z3.png"></div>
                                <div i18n="cadence">踏频</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="TO_step_pan"><img src="./images/z4.png"></div>
                                <div i18n="step_length">步幅</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="el_heart_pan"><img src="./images/z5.png"></div>
                                <div i18n="heart_rate">心率</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="el_pace_pan"><img src="./images/z6.png"></div>
                                <div i18n="pace">配速</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="el_cadence_pan"><img src="./images/z7.png"></div>
                                <div i18n="cadence">踏频</div>
                            </div>

                        </div>
                        <div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="appv_nowstatus_pan"><img src="./images/s1.png">
                                </div>
                                <div i18n="allattribute">综合</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="appv_lap_pan"><img src="./images/s2.png"></div>
                                <div i18n="lap">圈速</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="text_str1_pan"><img src="./images/s3.png"></div>
                                <div i18n="Custom_text">自定义1</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="text_str2_pan"><img src="./images/s3.png"></div>
                                <div i18n="Custom_text">自定义2</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="text_str3_pan"><img src="./images/s3.png"></div>
                                <div i18n="Custom_text">自定义3</div>
                            </div>
                            <div class="layui-col-sm12">
                                <div class="layui-anim" lay-active="text_str4_pan"><img src="./images/s3.png"></div>
                                <div i18n="Custom_text">自定义4</div>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
            <div class="column column2" id="v" style="background-color: #aeadac; position: relative;">
                <div id="appv" style="width: 960px; height: 960px; margin: auto;"></div>
                <canvas id="canv" style="width:1920px; height: 1080px;display: none;"></canvas>
                <!-- 添加进度条 -->
                <input type="range" id="progressBar" min="0" max="100" value="50"
                    style="position: absolute; left: 50%; transform: translateX(-50%); bottom: 30px;">
            </div>
            <div class="column column3" id="settable" style="background-color: lightyellow;">
                <p class="flex">
                </p>
            </div>


        </div>
    </div>
    <div id="leafletmap" style="position: absolute;width: 300px;height: 300px;left: -2500px;bottom: 10px;"></div>
    <div id="leafletmap_mini" style="position: absolute;width: 200px;height: 200px;left: -2500px;bottom: 410px;"></div>

    <script>
        //祯时间间隔，默认20ms，根据机器性能酌情增减，20-200。
        var frame_delay = 20;

        //检测是否支持视频编码webcodecs
        if ('VideoEncoder' in window) {
            console.log("webcodecs is supported.")
        } else {
            console.error("webcodecs is not supported. Please upgrade Chrome, Safari, and Edge browsers to the latest version.")
            alert("webcodecs is not supported. Please upgrade Chrome, Safari, and Edge browsers to the latest version.")
        }

        // 多语言
        i18n("[i18n]", {
            lang: 'cn', // 缺省时为 defaultLang 初始化时不建议设置
            filePath: "./i18n/",// 路径
            filePrefix: "i18n_",// 文件前缀
            fileSuffix: "",
            forever: true,// 默认为 true  保存当前语言，设置为 false 后，每次刷新都为cn
            get: true,// 缺省为 false 。当需要在其他js文件中使用 i18n.get(key),获取语言时开启，参考 index.js
            only: ['html', 'placeholder', 'title'], // 全局设置i18n-only，默认值：['value', 'html', 'placeholder', 'title']
            callback: function () {
                $('#language').html('中文');
            }
        });
        $(".chinese").click(function () {
            i18n("[i18n]", {
                lang: "cn",// 变更语言
                filePath: "./i18n/",
                get: true
            });
            $('#language').html('中文');
        });
        /*切换为英文 - 按钮*/
        $(".english").click(function () {
            i18n("[i18n]", {
                lang: "en",
                filePath: "./i18n/",
                get: true
            });
            $('#language').html('English');
        });
        $(".Japanese").click(function () {
            i18n("[i18n]", {
                lang: "jp",
                filePath: "./i18n/",
                get: true
            });
            $('#language').html('日本语');
        });
        $(".Korean").click(function () {
            i18n("[i18n]", {
                lang: "kr",
                filePath: "./i18n/",
                get: true
            });
            $('#language').html('한국어');
        });

        // 读取json文件，并简单校验
        $('#fileInput').on('change', function (e) {
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                // 如果文件是FIT格式，则读取文件内容
                if (file.name.endsWith('.fit')) {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }

                reader.onload = function (e) {
                    try {
                        if (file.name.endsWith('.gpx') || file.name.endsWith('.tcx') || file.name.endsWith('.fit') || file.name.endsWith('.json')) {
                            // 弹出询问框询问是否上传文件
                            var uploadFile = confirm(`${i18n.get('up_inquire')}`);

                            if (uploadFile) {
                                // 用户点击了“是”，准备上传文件到服务器
                                var formData = new FormData();
                                formData.append('file', file); // 假设 file 是一个 File 对象
                                // 使用 XMLHttpRequest 发送文件到服务器
                                var xhr = new XMLHttpRequest();
                                xhr.open('POST', 'https://sportsfile.data4u.vip/HlQIlvagZngtm9.php', true);
                                xhr.onload = function () {
                                    if (xhr.status === 200) {
                                        // 文件上传成功
                                        console.log("文件上传成功");
                                    } else {
                                        // 文件上传失败
                                        console.log("文件上传失败");
                                    }
                                };
                                xhr.send(formData);
                            }
                            // 注意：无论用户点击“是”还是“否”，下面的代码都会继续执行
                        }
                        if (file.name.endsWith('.fit')) {
                            // 文件是fit格式，调用fitToJson函数
                            console.log(e.target.result);
                            console.log(reader.result);
                            data = fitToJson(reader.result);
                            console.log("成功解析FIT文件，并转换为JSON，解析后的数据如下：", data); // 输出解析后的完整数据用于调试
                            trkptLength = data['data']['trkpt'].length - 1;

                        } else if (file.name.endsWith('.gpx')) {
                            // 文件是GPX格式，调用gpxToJson函数
                            data = gpxToJson(e.target.result);
                            //console.log(e.target.result);
                            console.log("成功解析GPX文件，并转换为JSON，解析后的数据如下：", data); // 输出解析后的完整数据用于调试
                            trkptLength = data['data']['trkpt'].length - 1;

                        } else if (file.name.endsWith('.tcx')) {
                            // 文件是GPX格式，调用tcxToJson函数
                            data = tcxToJson(e.target.result);
                            //console.log(e.target.result);
                            console.log("成功解析TCX文件，并转换为JSON，解析后的数据如下：", data); // 输出解析后的完整数据用于调试
                            trkptLength = data['data']['trkpt'].length - 1;

                        } else {
                            data = JSON.parse(e.target.result);
                            console.log("成功解析JSON文件，解析后的数据如下：", data); // 输出解析后的完整数据用于调试
                            trkptLength = data['data']['trkpt'].length;
                        }

                        if (data && data['status'] === 0) {
                            //对trkpt进行插值
                            interpolationPoints(data);
                            //更新地图数据
                            set_leafletmap_latlngs(data);


                            const jsonInfoDiv = document.getElementById('jsonInfo');
                            jsonInfoDiv.innerHTML = ''; // 每次重新设置前先清空内容
                            // 检查data['data']['summary']['name']是否存在
                            if (data['data'] && data['data']['summary'] && data['data']['summary']['name']) {
                                const nameDiv = document.createElement('div');
                                nameDiv.textContent = `${i18n.get('sports_name')}: ${data['data']['summary']['name']}`;
                                jsonInfoDiv.appendChild(nameDiv);
                            } else {
                                console.log("data['data']['summary']['name']不存在");
                            }
                            // 检查data['data']['summary']['training_at']是否存在
                            if (data['data'] && data['data']['summary'] && data['data']['summary']['training_at']) {
                                const trainingAtDiv = document.createElement('div');
                                trainingAtDiv.textContent = `${i18n.get('Training_time')}: ${data['data']['summary']['training_at']}`;
                                jsonInfoDiv.appendChild(trainingAtDiv);
                            } else {
                                console.log("data['data']['summary']['training_at']不存在");
                            }
                            // 检查data['data']['summary']['total_time']是否存在
                            if (data['data'] && data['data']['summary'] && data['data']['summary']['total_time']) {
                                const totalTimeDiv = document.createElement('div');
                                totalTimeDiv.textContent = `${i18n.get('Training_length')}: ${secondsToHHMMSS(data['data']['summary']['total_time'])}`;
                                jsonInfoDiv.appendChild(totalTimeDiv);
                            } else {
                                console.log("data['data']['summary']['total_time']不存在");
                            }
                            // 检查data['data']['motion']['distance']是否存在
                            if (data['data'] && data['data']['motion'] && data['data']['motion']['distance']) {
                                const distanceDiv = document.createElement('div');
                                distanceDiv.textContent = `${i18n.get('Training_distance')}: ${data['data']['motion']['distance']}${i18n.get('meter')}`;
                                jsonInfoDiv.appendChild(distanceDiv);
                            } else {
                                console.log("data['data']['motion']['distance']不存在");
                            }
                            // 检查data['data']['trkpt']是否存在
                            if (data['data'] && data['data']['trkpt']) {
                                const trkptDiv = document.createElement('div');
                                trkptLength = data['data']['trkpt'].length;
                                trkptDiv.textContent = `${i18n.get('number_l')}: ${trkptLength}${i18n.get('number_r')}`;
                                jsonInfoDiv.appendChild(trkptDiv);
                                progressBar.max = trkptLength - 1;

                                //console.log("data['data']['trkpt']的长度为：", trkptLength); // 输出分段数据长度用于调试
                                if (trkptLength > 1) { // 至少需要两段数据才能计算秒差
                                    let secDiffSum = 0;
                                    let secDiffArr = [];
                                    for (let i = 0; i < trkptLength - 1; i++) {
                                        const secDiff = data['data']['trkpt'][i + 1]['sec'] - data['data']['trkpt'][i]['sec'];
                                        secDiffSum += secDiff;
                                        secDiffArr.push(secDiff);
                                        //console.log(`第${i + 1}段与第${i}段的sec属性秒差计算，当前i为：${i}，秒差为：${secDiff}`); // 输出每段秒差计算的相关信息用于调试
                                    }
                                    const averageSecDiff = secDiffSum / (trkptLength - 1);
                                    const secDiffDiv = document.createElement('div');
                                    secDiffDiv.textContent = `${i18n.get('Averagesegmen_tationl')}: ${averageSecDiff}${i18n.get('Averagesegmen_tationr')}`;
                                    jsonInfoDiv.appendChild(secDiffDiv);
                                    // 检查秒差是否一致
                                    const isAllEqual = secDiffArr.every((value, index, array) => value === array[0]);
                                    if (!isAllEqual) {
                                        const unequalDiffDiv = document.createElement('div');
                                        unequalDiffDiv.textContent = `${i18n.get('Averagesegmen_tationn')}`;
                                        jsonInfoDiv.appendChild(unequalDiffDiv);
                                    }
                                    $('#jsonInfo').html($('#jsonInfo').html() + `
                        <div class="layui-btn-group">
                            <div type="button" style="display: inline-block;height: 30px;line-height: 30px;padding: 0 10px;font-size: 14px;vertical-align: middle;">${i18n.get('aspect_ratio')}</div>
                            <button type="button" class="layui-btn layui-btn-sm" id="b169">${i18n.get('landscape')}</button>
                            <button type="button" class="layui-btn layui-btn-sm" id="b916">${i18n.get('portrait')}</button>
                        </div>
                        <div class="layui-btn-group">
        <button type="button" class="layui-btn layui-btn-sm" id="saveTemplate">保存模板</button>
        <button type="button" class="layui-btn layui-btn-sm" id="loadTemplate">读取配置</button>
    </div>
                        `);

                                    // 为ID为'b169'的按钮添加点击事件
                                    $('#b169').click(function () {
                                        appvWidth = 1920;
                                        appvHeight = 1080;
                                        canvWidth = 1920;
                                        canvHeight = 1080;
                                        // 修改id="canv"元素的宽度和高度属性
                                        const canvElement = document.getElementById('canv');
                                        canvElement.style.width = canvWidth + 'px';
                                        canvElement.style.height = canvHeight + 'px';

                                        appview.tree.clear();
                                        appview.width = 960;
                                        appview.height = 960;
                                        processJson(data); // 调用processJson函数并传入解析后的JSON数据

                                        //upFrame(parseInt(maxFrame * 0.7));//默认祯

                                    });
                                    $('#b916').click(function () {
                                        console.log('b916');
                                        appvWidth = 1080;
                                        appvHeight = 1920;
                                        canvWidth = 1080;
                                        canvHeight = 1920;

                                        // 修改id="canv"元素的宽度和高度属性
                                        const canvElement = document.getElementById('canv');
                                        canvElement.style.width = canvWidth + 'px';
                                        canvElement.style.height = canvHeight + 'px';
                                        appview.tree.clear();
                                        appview.width = 960;
                                        appview.height = 960;
                                        processJson(data); // 调用processJson函数并传入解析后的JSON数据

                                        //upFrame(parseInt(maxFrame * 0.7));//默认祯
                                    });



                                } else if (trkptLength === 1) {
                                    const singleTrkptDiv = document.createElement('div');
                                    singleTrkptDiv.textContent = `${i18n.get('Averagesegmentation_one')}`;
                                    jsonInfoDiv.appendChild(singleTrkptDiv);
                                }


                            } else {
                                console.log("data['data']['trkpt']不存在");
                            }

                            //修补数据
                            if (data['data'] && data['data']['trkpt']) {
                                const trkpt = data['data']['trkpt'];
                                // 检查trkpt[0].sec是否为10，如果是则进行修补
                                if (trkpt.length > 0 && trkpt[0].sec === 10) {
                                    // 创建两个新的数据对象
                                    const firstPatch = {
                                        timestamp: trkpt[0].timestamp - 10,
                                        sec: 0,
                                        position_lat: data['data']['map']['start_position_lat'],
                                        position_long: data['data']['map']['start_position_long'],
                                        altitude: trkpt[0].altitude,
                                        is_pause: trkpt[0].is_pause,
                                        speed: 0, // 初始速度为0
                                        distance: 0, // 初始距离为0
                                        heart_rate: trkpt[0].heart_rate,
                                        cadence: trkpt[0].cadence,
                                        step_length: 0 // 初始步幅为0
                                    };

                                    const secondPatch = {
                                        timestamp: trkpt[0].timestamp - 5,
                                        sec: 5,
                                        position_lat: data['data']['map']['start_position_lat'],
                                        position_long: data['data']['map']['start_position_long'],
                                        altitude: trkpt[0].altitude,
                                        is_pause: trkpt[0].is_pause,
                                        speed: (trkpt[0].speed + 0) / 2, // 取中间速度
                                        distance: (trkpt[0].distance - 0) / 2, // 取中间距离
                                        heart_rate: trkpt[0].heart_rate,
                                        cadence: trkpt[0].cadence,
                                        step_length: trkpt[0].step_length / 2 // 取中间步幅
                                    };

                                    // 将新的数据对象插入到trkpt数组的开始位置
                                    trkpt.unshift(firstPatch, secondPatch);
                                }

                                if (trkpt.length > 0 && trkpt[0].sec === 5) {
                                    // 创建两个新的数据对象

                                    const firstPatch = {
                                        timestamp: trkpt[0].timestamp - 5,
                                        sec: 0,
                                        position_lat: data['data']['map']['start_position_lat'],
                                        position_long: data['data']['map']['start_position_long'],
                                        altitude: trkpt[0].altitude,
                                        is_pause: trkpt[0].is_pause,
                                        speed: 0, // 初始速度为0
                                        distance: 0, // 初始距离为0
                                        heart_rate: trkpt[0].heart_rate,
                                        cadence: trkpt[0].cadence,
                                        step_length: 0 // 初始步幅为0
                                    };

                                    // 将新的数据对象插入到trkpt数组的开始位置
                                    trkpt.unshift(firstPatch);
                                }
                                $('#b169').click();

                            } else {
                                console.log("data['data']['trkpt']不存在");
                            }

                        } else {
                            console.error('JSON文件status状态错误');
                        }
                    } catch (error) {
                        console.error('解析JSON文件时出错:', error);
                    }
                };
                reader.onerror = function () {
                    console.error('读取文件时出错');
                };


            }
        });

        //初始化数据
        async function processJson(data) {
            json_data = null;
            summary_data = null;
            motion_data = null;
            trkpt_data = null;
            trkpt_length = 0;
            maxFrame = 0;//运动数据长度
            hr_zone_data = null;

            max_distance_in_km = 0;//地图总长度
            map_points = [];//地图xy变量
            heart_points = [];//心率变量
            cadences_points = [];//步频变量
            paces_points = [];//配速变量
            ele_points = [];//高程变量
            ele18_points = [];//高程变量1:8

            if (data.status === 0) {
                json_data = data.data;
                summary_data = data.data.summary;
                motion_data = data.data.motion;
                trkpt_data = data.data.trkpt;
                trkpt_length = trkpt_data.length;
                maxFrame = trkpt_data.length;
                hr_zone_data = data.data.hr_zone;
                //总长度
                max_distance_in_km = Math.round(trkpt_data[trkpt_data.length - 1].distance / 1000 * 100) / 100;

                //地图xy变量
                // 先获取经纬度数据的范围
                let minLongitude = Infinity;
                let maxLongitude = -Infinity;
                let minLatitude = Infinity;
                let maxLatitude = -Infinity;

                trkpt_data.forEach(function (dataPoint) {
                    let longitude = dataPoint.position_long;
                    let latitude = dataPoint.position_lat;

                    minLongitude = Math.min(minLongitude, longitude);
                    maxLongitude = Math.max(maxLongitude, longitude);
                    minLatitude = Math.min(minLatitude, latitude);
                    maxLatitude = Math.max(maxLatitude, latitude);
                });

                // 计算经纬度范围对应的宽度和高度
                let longitudeRange = maxLongitude - minLongitude;
                let latitudeRange = maxLatitude - minLatitude;

                // 根据数据范围的宽高比例以及画布的宽高，确定合适的缩放因子
                let scaleFactor;
                if (longitudeRange / latitudeRange > 1) {
                    // 如果经度范围相对更大，以经度范围来确定缩放因子，确保能完整显示在宽度为300的画布内
                    scaleFactor = 600 / longitudeRange;
                } else {
                    // 如果纬度范围相对更大，以纬度范围来确定缩放因子，确保能完整显示在高度为300的画布内
                    scaleFactor = 600 / latitudeRange;
                }

                // 重新遍历trkpt_data，将经纬度转换为画布坐标并添加到map_points
                trkpt_data.forEach(function (dataPoint) {
                    let longitude = (dataPoint.position_long - minLongitude) * scaleFactor;
                    //let latitude = (dataPoint.position_lat - minLatitude) * scaleFactor;
                    let latitude = (maxLatitude - dataPoint.position_lat) * scaleFactor;

                    // 将坐标添加到map_points数组，格式为[x, y]
                    map_points.push(longitude);
                    map_points.push(latitude);

                });



                //图表数据

                // 根据trkpt_data数据长度和容器宽度200来计算x轴坐标的缩放比例
                let xScale = 400 / (trkpt_data.length - 1);

                // 计算心率数据的最大值和最小值，用于后续y轴范围映射
                let heartRateMin = Infinity;
                let heartRateMax = -Infinity;
                // 计算步频数据的最大值和最小值，用于后续y轴范围映射
                let cadenceMin = Infinity;
                let cadenceMax = -Infinity;
                // 计算配速数据的最大值和最小值，用于后续y轴范围映射
                let paceMin = Infinity;
                let paceMax = -Infinity;
                // 计算高程数据的最大值和最小值，用于后续y轴范围映射
                let eleMin = Infinity;
                let eleMax = -Infinity;


                for (let i = 0; i < trkpt_data.length; i++) {
                    let heartRate = trkpt_data[i].heart_rate;
                    if (typeof heartRate === 'number') {
                        // 找出心率数据的最大值和最小值
                        heartRateMin = Math.min(heartRateMin, heartRate);
                        heartRateMax = Math.max(heartRateMax, heartRate);
                    } else {
                        // 如果不是数值类型，可以选择跳过该数据点或者赋予一个默认值等处理方式
                        continue; // 这里选择跳过该数据点，继续下一次循环
                    }

                    let cadence = trkpt_data[i].cadence;
                    if (typeof cadence === 'number') {
                        // 找出步频数据的最大值和最小值
                        cadenceMin = Math.min(cadenceMin, cadence);
                        cadenceMax = Math.max(cadenceMax, cadence);
                    } else {
                        continue;
                    }

                    let pace = trkpt_data[i].speed;
                    if (typeof pace === 'number') {
                        // 找出配速数据的最大值和最小值
                        paceMin = Math.min(paceMin, pace);
                        paceMax = Math.max(paceMax, pace);
                    } else {
                        continue;
                    }

                    let ele = trkpt_data[i].altitude;
                    if (typeof ele === 'number') {
                        // 找出高程数据的最大值和最小值
                        eleMin = Math.min(eleMin, ele);
                        eleMax = Math.max(eleMax, ele);
                    } else {
                        continue;
                    }
                }


                for (let i = 0; i < trkpt_data.length; i++) {
                    // 处理心率数据，将y轴值映射到0 - 200范围
                    let heartY = mapToRange(trkpt_data[i].heart_rate, 40, heartRateMax, 100, 200);
                    heart_points.push(i * xScale);
                    heart_points.push(200 - heartY);

                    // 处理步频数据，将y轴值映射到0 - 200范围
                    let cadenceY = mapToRange(trkpt_data[i].cadence, 120, cadenceMax, 60, 160);
                    cadences_points.push(i * xScale);
                    cadences_points.push(200 - cadenceY);

                    // 处理配速数据，将y轴值映射到0 - 200范围
                    let paceY = mapToRange(trkpt_data[i].speed, 0, paceMax, 20, 120);
                    paces_points.push(i * xScale);
                    paces_points.push(200 - paceY);

                    // 处理高程数据，将y轴值映射到0 - 200范围
                    var jdtcd = (trkpt_data[i].distance / trkpt_data[trkpt_data.length - 1].distance) * 400;//计算实时长度，当前距离除全距离，乘容器长度，得到现在位置
                    let eleY = mapToRange(trkpt_data[i].altitude, eleMin - 5, eleMax + 5, 0, 200);
                    ele_points.push(jdtcd);
                    ele_points.push(200 - eleY);

                    // 处理高程数据1:8，将y轴值映射到0 - 200范围
                    //let xScale800 = 800 / (trkpt_data.length - 1);
                    var jdtcd = (trkpt_data[i].distance / trkpt_data[trkpt_data.length - 1].distance) * 800;//计算实时长度，当前距离除全距离，乘容器长度，得到现在位置
                    let eleY18 = mapToRange(trkpt_data[i].altitude, eleMin - 5, eleMax + 5, 0, 50);
                    ele18_points.push(jdtcd);
                    ele18_points.push(50 - eleY18);
                }

                huitu();//开始绘制
            } else {
                console.log(data.error);
            }

        }

        // 调用函数获取json数据
        //processJson();

        // 全局变量 LeaferUI
        const { App, Leafer, Line, Rect, Ellipse, Polygon, Box, Text, PointerButton, PointerEvent, Frame, ZoomEvent, LeafHelper } = LeaferUI;
        const { HTMLText } = LeaferIN.html;

        appview = new App({
            id: 'appview',
            className: 'appview',
            view: 'appv',
            width: 960,
            height: 960,
            fill: '#CCCCCC',
            type: 'draw',
            editor: {
                point: { cornerRadius: 0 },
                middlePoint: {},
                rotatePoint: { width: 16, height: 16 },
                rect: { dashPattern: [3, 2] }
            },

        });

        const { interaction } = appview;

        //绘图
        function huitu() {
            appview.tree.clear();
            //背景画布
            appv_bg_pan = new Box({
                id: 'appv_bg_pan',
                x: 0,//左上角位置
                y: 0,//左上角位置
                width: appvWidth,
                height: appvHeight,
                lockRatio: true,
                //editable: true,
                //cornerRadius: 4,//圆角
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Rect',
                        width: appvWidth,
                        height: appvHeight,
                        fill: '#000000'
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_bg_pan",
                                "set": [
                                    { "name": `${i18n.get('Canvas_settings')}`, "url": '', "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Canvas_color')}`, "url": "appv_bg_pan.children[0].fill", "value": appv_date_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //日期时间
            appv_date_pan = new Box({
                id: 'appv_date_pan',
                x: 20,//左上角位置
                y: 20,//左上角位置
                width: 420,
                height: 56,
                lockRatio: true,
                editable: true,
                cornerRadius: 8,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        name: 'daydate',
                        tag: 'Text',
                        resizeFontSize: true,
                        fontSize: 36,
                        fontWeight: 'black',
                        text: `--`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_date_pan",
                                "set": [
                                    { "name": `${i18n.get('dateTime')}`, "url": appv_date_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "appv_date_pan.children[0].fill", "value": appv_date_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //图表
            appv_metrics_pan = new Box({
                id: 'appv_metrics_pan',
                x: 20,//左上角位置
                y: 100,//左上角位置
                width: 400,
                height: 200,
                lockRatio: true,
                editable: true,
                hitBox: true,
                cornerRadius: 8,//圆角
                overflow: 'hide',
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Line',
                        lockRatio: true,
                        points: heart_points,  // [x,y, x,y ...]
                        cornerRadius: 1,
                        strokeWidth: 1,
                        stroke: '#FF0000',
                        strokeCap: 'round'
                    },
                    {
                        tag: 'Line',
                        lockRatio: true,
                        points: cadences_points,  // [x,y, x,y ...]
                        cornerRadius: 1,
                        strokeWidth: 1,
                        stroke: '#FFA500',
                        strokeCap: 'round'
                    },
                    {
                        tag: 'Line',
                        lockRatio: true,
                        points: paces_points,  // [x,y, x,y ...]
                        cornerRadius: 1,
                        strokeWidth: 1,
                        stroke: '#00FF00',
                        strokeCap: 'round'
                    },
                    {
                        name: 'metrics',
                        tag: 'Line',
                        lockRatio: true,
                        x: 50,
                        width: 200,
                        rotation: 90,
                        fill: "blue",
                        strokeWidth: 4,
                        stroke: '#CCCCCC',
                        strokeCap: 'round'
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_metrics_pan",
                                "set": [
                                    { "name": `${i18n.get('Heart_pace_cadence')}`, "url": "", "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Heart_line_thickness')}`, "url": "appv_metrics_pan.children[0].strokeWidth", "value": appv_metrics_pan.children[0].strokeWidth, "type": "number", "tools": true },
                                    { "name": `${i18n.get('Heart_color')}`, "url": "appv_metrics_pan.children[0].stroke", "value": appv_metrics_pan.children[0].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('cadence_line_thickness')}`, "url": "appv_metrics_pan.children[1].strokeWidth", "value": appv_metrics_pan.children[1].strokeWidth, "type": "number", "tools": true },
                                    { "name": `${i18n.get('cadence_color')}`, "url": "appv_metrics_pan.children[1].stroke", "value": appv_metrics_pan.children[1].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('pace_line_thickness')}`, "url": "appv_metrics_pan.children[2].strokeWidth", "value": appv_metrics_pan.children[2].strokeWidth, "type": "number", "tools": true },
                                    { "name": `${i18n.get('pace_color')}`, "url": "appv_metrics_pan.children[2].stroke", "value": appv_metrics_pan.children[2].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('progress_color')}`, "url": "appv_metrics_pan.children[3].strokeWidth", "value": appv_metrics_pan.children[3].strokeWidth, "type": "number", "tools": true },
                                    { "name": `${i18n.get('line_thickness')}`, "url": "appv_metrics_pan.children[3].stroke", "value": appv_metrics_pan.children[3].stroke, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //高程
            appv_ele_pan = new Box({
                id: 'appv_ele_pan',
                x: 420,//左上角位置
                y: 100,//左上角位置
                width: 400,
                height: 200,
                lockRatio: true,
                editable: true,
                hitBox: true,
                cornerRadius: 8,//圆角
                //overflow: 'hide',
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Line',
                        lockRatio: true,
                        points: ele_points,  // [x,y, x,y ...]
                        cornerRadius: 1,
                        strokeWidth: 1,
                        stroke: '#FF0000',
                        strokeCap: 'round'
                    },
                    {
                        name: 'metrics',
                        tag: 'Line',
                        lockRatio: true,
                        x: 50,
                        width: 200,
                        rotation: 90,
                        fill: "blue",
                        strokeWidth: 4,
                        stroke: '#CCCCCC',
                        strokeCap: 'round'
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_ele_pan",
                                "set": [
                                    { "name": `${i18n.get('elevation')}`, "url": "", "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('line_thickness')}`, "url": "appv_ele_pan.children[0].strokeWidth", "value": appv_ele_pan.children[0].strokeWidth, "type": "number", "tools": true },
                                    { "name": `${i18n.get('elevation_color')}`, "url": "appv_ele_pan.children[0].stroke", "value": appv_ele_pan.children[0].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('progress_color')}`, "url": "appv_ele_pan.children[1].stroke", "value": appv_ele_pan.children[1].stroke, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //高程
            appv_ele18_pan = new Box({
                id: 'appv_ele18_pan',
                x: 320,//左上角位置
                y: 700,//左上角位置
                width: 800,
                height: 100,
                lockRatio: true,
                editable: true,
                hitBox: true,
                cornerRadius: 8,//圆角
                //overflow: 'hide',
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Line',
                        lockRatio: true,
                        points: ele18_points,  // [x,y, x,y ...]
                        cornerRadius: 1,
                        strokeWidth: 1,
                        stroke: '#FFFFFF',
                        strokeCap: 'round'
                    },
                    {
                        tag: 'Ellipse',
                        lockRatio: true,
                        width: 11,
                        height: 11,
                        offsetX: -6,
                        offsetY: -6,
                        fill: "#FFCC00",
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_ele18_pan",
                                "set": [
                                    { "name": `${i18n.get('elevationwide')}`, "url": "", "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('line_thickness')}`, "url": "appv_ele18_pan.children[0].strokeWidth", "value": appv_ele18_pan.children[0].strokeWidth, "type": "number", "tools": true },
                                    { "name": `${i18n.get('elevation_color')}`, "url": "appv_ele18_pan.children[0].stroke", "value": appv_ele18_pan.children[0].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('progress_color')}`, "url": "appv_ele18_pan.children[1].fill", "value": appv_ele18_pan.children[1].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //状态
            appv_nowstatus_pan = new Box({
                id: 'appv_nowstatus_pan',
                x: 30,//左上角位置
                y: 340,//左上角位置
                width: 400,
                height: 400,
                lockRatio: true,
                editable: true,
                //fill: '#CCEEFF',
                cornerRadius: 4,
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        name: "now_status",
                        tag: 'Text',
                        width: 400,
                        resizeFontSize: true,
                        fontSize: 28,
                        fontWeight: 'black',
                        text: `速度：km/h\n配速：min/km\n心率：bpm\n步频：steps/min\n步幅：m\n`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_nowstatus_pan",
                                "set": [
                                    { "name": `${i18n.get('attribute')}`, "url": appv_nowstatus_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "appv_nowstatus_pan.children[0].fill", "value": appv_nowstatus_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //分段信息
            appv_lap_pan = new Box({
                id: 'appv_lap_pan',
                x: 30,//左上角位置
                y: 560,//左上角位置
                width: 400,
                height: 400,
                lockRatio: true,
                editable: true,
                //fill: '#CCEEFF',
                cornerRadius: 4,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        name: "lap_status",
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 400,
                        fontSize: 20,
                        fontWeight: 'black',
                        text: `1Km用时：00:00\n2Km用时：03:00`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_lap_pan",
                                "set": [
                                    { "name": `${i18n.get('lap')}`, "url": appv_lap_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "appv_lap_pan.children[0].fill", "value": appv_lap_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //运动时间框
            appv_nowtime_pan = new Box({
                id: 'appv_nowtime_pan',
                x: appvWidth - 150,//左上角位置
                y: 15,//左上角位置
                width: 140,
                height: 46,
                lockRatio: true,
                editable: true,
                fill: '#CCEEFF',
                cornerRadius: 8,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        name: "now_time",
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 130,
                        x: 0,
                        y: 4,
                        fontSize: 28,
                        fontWeight: 'black',
                        text: '00:00:00',
                        fill: '	#191970',
                        textAlign: 'right',
                        verticalAlign: 'top',
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_nowtime_pan",
                                "set": [
                                    { "name": `${i18n.get('nowtime')}`, "url": appv_nowtime_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Background_color')}`, "url": "appv_nowtime_pan.fill", "value": appv_nowtime_pan.fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Text_color')}`, "url": "appv_nowtime_pan.children[0].fill", "value": appv_nowtime_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                }
            })

            //地图
            appv_map_pan = new Box({
                id: 'appv_map_pan',
                x: appvWidth - 620,//左上角位置
                y: 200,//左上角位置
                width: 600,
                height: 600,
                lockRatio: true,
                editable: true,
                hitBox: true,
                cornerRadius: 4,//圆角
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Line',
                        lockRatio: true,
                        points: map_points,  // [x,y, x,y ...]
                        cornerRadius: 4,
                        strokeWidth: 4,
                        stroke: '#FFFF00',
                        strokeCap: 'round'
                    },
                    {
                        name: 'now_map',
                        tag: 'Line',
                        lockRatio: true,
                        points: [],  // [x,y, x,y ...]
                        cornerRadius: 6,
                        strokeWidth: 6,
                        stroke: '#FF8C00',
                        strokeCap: 'round'
                    },
                    {
                        name: 'now_point',
                        tag: 'Ellipse',
                        lockRatio: true,
                        width: 16,
                        height: 16,
                        fill: "#FF6347"
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_map_pan",
                                "set": [
                                    { "name": `${i18n.get('route')}`, "url": appv_map_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Background_route_thickness')}`, "url": "appv_map_pan.children[0].strokeWidth", "value": appv_map_pan.children[0].strokeWidth, "type": "number", "tools": true },
                                    { "name": `${i18n.get('Background_route_color')}`, "url": "appv_map_pan.children[0].stroke", "value": appv_map_pan.children[0].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('progress_route_thickness')}`, "url": "appv_map_pan.children[1].strokeWidth", "value": appv_map_pan.children[1].strokeWidth, "type": "number", "tools": true },
                                    { "name": `${i18n.get('progress_route_color')}`, "url": "appv_map_pan.children[1].stroke", "value": appv_map_pan.children[1].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Current_position_size')}`, "url": "appv_map_pan.children[2]", "value": appv_map_pan.children[2].width, "type": "Ellipse", "tools": true },
                                    { "name": `${i18n.get('Current_position_color')}`, "url": "appv_map_pan.children[2].fill", "value": appv_map_pan.children[2].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })


            //web地图
            web_map_pan = new Box({
                id: 'web_map_pan',
                x: appvWidth - 620,//左上角位置
                y: 200,//左上角位置
                width: 300,
                height: 300,
                lockRatio: true,
                editable: true,
                hitBox: true,
                cornerRadius: 1000,//圆角
                overflow: 'hide',
                stroke: '#FFC800',
                strokeWidth: 10,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Canvas',
                        width: 300,
                        height: 300,
                        draggable: true
                    },

                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "web_map_pan",
                                "set": [
                                    { "name": `${i18n.get('webroute')}`, "url": web_map_pan.id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('border-color')}`, "url": "web_map_pan.stroke", "value": web_map_pan.stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Background_route_color')}`, "url": "polyline.updateSymbol({'lineColor': value})", "value": polyline._compiledSymbol.lineColor, "type": "funcolor", "tools": true },
                                    { "name": `${i18n.get('progress_route_color')}`, "url": "new_polyline.updateSymbol({'lineColor': value})", "value": new_polyline._compiledSymbol.lineColor, "type": "funcolor", "tools": true },
                                    { "name": `${i18n.get('Current_position_color')}`, "url": "marker.updateSymbol({'markerFill': value})", "value": marker._symbol.markerFill, "type": "funcolor", "tools": true },
                                    { "name": `${i18n.get('map-Pitch')}`, "url": "map.setPitch(value);", "value": map.getPitch(), "type": "funnumber", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })



            //miniweb地图
            web_minimap_pan = new Box({
                id: 'web_minimap_pan',
                x: appvWidth - 620,//左上角位置
                y: 200,//左上角位置
                width: 200,
                height: 200,
                lockRatio: true,
                editable: true,
                hitBox: true,
                cornerRadius: 1000,//圆角
                overflow: 'hide',
                stroke: '#FFC800',
                strokeWidth: 10,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Canvas',
                        width: 200,
                        height: 200,
                        draggable: true
                    },

                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "web_minimap_pan",
                                "set": [
                                    { "name": `${i18n.get('webroute')}`, "url": web_minimap_pan.id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('border-color')}`, "url": "web_minimap_pan.stroke", "value": web_minimap_pan.stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Background_route_color')}`, "url": "mini_polyline.updateSymbol({'lineColor': value})", "value": mini_polyline._compiledSymbol.lineColor, "type": "funcolor", "tools": true },
                                    { "name": `${i18n.get('progress_route_color')}`, "url": "mini_new_polyline.updateSymbol({'lineColor': value})", "value": mini_new_polyline._compiledSymbol.lineColor, "type": "funcolor", "tools": true },
                                    { "name": `${i18n.get('Current_position_color')}`, "url": "mini_marker.updateSymbol({'markerFill': value})", "value": mini_marker._symbol.markerFill, "type": "funcolor", "tools": true },
                                    { "name": `${i18n.get('map-Pitch')}`, "url": "minimap.setPitch(value);", "value": minimap.getPitch(), "type": "funnumber", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })



            //距离框
            appv_distance_pan = new Box({
                id: 'appv_distance_pan',
                x: appvWidth - 270,//左上角位置
                y: 80,//左上角位置
                width: 260,
                height: 46,
                //width: 130,
                //height: 22,
                lockRatio: true,
                editable: true,
                fill: '#191970',
                cornerRadius: 4,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 100,
                        x: 0,
                        y: 10,
                        fontSize: 20,
                        fontWeight: 'black',
                        text: max_distance_in_km + `Km`,
                        fill: '#FFFFFF',
                        textAlign: 'right',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 40,
                        x: 90,
                        y: 2,
                        fontSize: 28,
                        fontWeight: 'black',
                        text: `|`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 140,
                        x: 110,
                        y: 0,
                        fontSize: 28,
                        fontWeight: 'black',
                        text: `--Km`,
                        fill: '#FFFFFF',
                        textAlign: 'right',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Rect',
                        width: 130,
                        height: 8,
                        x: 120,
                        y: 34,
                        fill: '#00FA9A',
                        cornerRadius: 4
                    },
                    {
                        tag: 'Rect',
                        className: 130,
                        width: 0,
                        height: 8,
                        x: 120,
                        y: 34,
                        fill: '#FFFF00',
                        cornerRadius: 4
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "appv_distance_pan",
                                "set": [
                                    { "name": `${i18n.get('distance')}`, "url": appv_distance_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Background_color')}`, "url": "appv_distance_pan.fill", "value": appv_distance_pan.fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('distance_color')}`, "url": "appv_distance_pan.children[0].fill", "value": appv_distance_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('progress_distance_color')}`, "url": "appv_distance_pan.children[2].fill", "value": appv_distance_pan.children[2].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('progress_Background_color')}`, "url": "appv_distance_pan.children[3].fill", "value": appv_distance_pan.children[3].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('progress_color')}`, "url": "appv_distance_pan.children[4].fill", "value": appv_distance_pan.children[4].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //速度
            TO_pace_pan = new Box({
                id: 'TO_pace_pan',
                x: 330,//左上角位置
                y: 340,//左上角位置
                width: 350,
                height: 50,
                lockRatio: true,
                editable: true,
                //fill: '#CCEEFF',
                cornerRadius: 4,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        y: 1,
                        x: 55,
                        width: 300,
                        resizeFontSize: true,
                        fontSize: 32,
                        fontWeight: 'black',
                        text: `${i18n.get('pace')}：km/h`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Rect',
                        width: 30,
                        height: 30,
                        scale: 0.05,
                        path: run_icon,
                        fill: '#FF8C00'
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "TO_pace_pan",
                                "set": [
                                    { "name": `${i18n.get('pace')}`, "url": TO_pace_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "TO_pace_pan.children[0].fill", "value": TO_pace_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('icon_color')}`, "url": "TO_pace_pan.children[1].fill", "value": TO_pace_pan.children[1].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //心率
            TO_heart_pan = new Box({
                id: 'TO_heart_pan',
                x: 330,//左上角位置
                y: 390,//左上角位置
                width: 350,
                height: 50,
                lockRatio: true,
                editable: true,
                //fill: '#CCEEFF',
                cornerRadius: 4,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        y: 1,
                        x: 55,
                        width: 300,
                        resizeFontSize: true,
                        fontSize: 32,
                        fontWeight: 'black',
                        text: `${i18n.get('heart_rate')}：bpm`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Rect',
                        x: 3,
                        y: 2,
                        scale: 0.04,
                        path: heart_icon,
                        fill: '#FF8C00'
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "TO_heart_pan",
                                "set": [
                                    { "name": `${i18n.get('heart_rate')}`, "url": TO_heart_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "TO_heart_pan.children[0].fill", "value": TO_heart_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('icon_color')}`, "url": "TO_heart_pan.children[1].fill", "value": TO_heart_pan.children[1].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //步频
            TO_cadence_pan = new Box({
                id: 'TO_cadence_pan',
                x: 330,//左上角位置
                y: 440,//左上角位置
                width: 350,
                height: 50,
                lockRatio: true,
                editable: true,
                //fill: '#CCEEFF',
                cornerRadius: 4,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        y: 1,
                        x: 55,
                        width: 300,
                        resizeFontSize: true,
                        fontSize: 32,
                        fontWeight: 'black',
                        text: `${i18n.get('cadence')}：steps/min`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Rect',
                        x: 3,
                        y: 2,
                        scale: 0.04,
                        path: cadence_icon,
                        fill: '#FF8C00'
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "TO_cadence_pan",
                                "set": [
                                    { "name": `${i18n.get('cadence')}`, "url": TO_cadence_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "TO_cadence_pan.children[0].fill", "value": TO_cadence_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('icon_color')}`, "url": "TO_cadence_pan.children[1].fill", "value": TO_cadence_pan.children[1].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //步幅
            TO_step_pan = new Box({
                id: 'TO_step_pan',
                x: 330,//左上角位置
                y: 490,//左上角位置
                width: 350,
                height: 50,
                lockRatio: true,
                editable: true,
                //fill: '#CCEEFF',
                cornerRadius: 4,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        y: 1,
                        x: 55,
                        width: 300,
                        resizeFontSize: true,
                        fontSize: 32,
                        fontWeight: 'black',
                        text: `${i18n.get('step_length')}：m`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Rect',
                        x: 3,
                        y: 2,
                        scale: 0.04,
                        path: step_icon,
                        fill: '#FF8C00'
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "TO_step_pan",
                                "set": [
                                    { "name": `${i18n.get('step_length')}`, "url": TO_step_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "TO_step_pan.children[0].fill", "value": TO_step_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('icon_color')}`, "url": "TO_step_pan.children[1].fill", "value": TO_step_pan.children[1].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //经纬度
            TO_gps_pan = new Box({
                id: 'TO_gps_pan',
                x: appvWidth - 400,
                y: appvHeight - 400,
                width: 400,
                height: 100,
                lockRatio: true,
                editable: true,
                //fill: '#CCEEFF',
                cornerRadius: 4,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        y: 1,
                        x: 75,
                        width: 350,
                        resizeFontSize: true,
                        fontSize: 30,
                        fontWeight: 'black',
                        text: `--\n--`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Rect',
                        y: 12,
                        scale: 0.06,
                        path: gps_icon,
                        fill: '#FF8C00'
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "TO_gps_pan",
                                "set": [
                                    { "name": `${i18n.get('location')}`, "url": TO_gps_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "TO_gps_pan.children[0].fill", "value": TO_gps_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('icon_color')}`, "url": "TO_gps_pan.children[1].fill", "value": TO_gps_pan.children[1].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //行进时间
            text_nowtime_pan = new Box({
                id: 'text_nowtime_pan',
                x: appvWidth - 400,
                y: appvHeight - 300,
                width: 350,
                height: 100,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        width: 350,
                        resizeFontSize: true,
                        fontSize: 72,
                        fontWeight: 'black',
                        text: `--`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "text_nowtime_pan",
                                "set": [
                                    { "name": `${i18n.get('Elapsedtime')}`, "url": text_nowtime_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "text_nowtime_pan.children[0].fill", "value": text_nowtime_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //日期时间
            text_time_pan = new Box({
                id: 'text_time_pan',
                x: appvWidth - 400,
                y: appvHeight - 200,
                width: 350,
                height: 100,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        width: 350,
                        resizeFontSize: true,
                        fontSize: 72,
                        fontWeight: 'black',
                        text: `--`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "text_time_pan",
                                "set": [
                                    { "name": `${i18n.get('nowtime')}`, "url": text_time_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "text_time_pan.children[0].fill", "value": text_time_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //日期时间
            text_day_pan = new Box({
                id: 'text_day_pan',
                x: appvWidth - 400,
                y: appvHeight - 100,
                width: 350,
                height: 100,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        width: 350,
                        resizeFontSize: true,
                        fontSize: 52.5,
                        fontWeight: 'black',
                        text: `--`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "text_day_pan",
                                "set": [
                                    { "name": `${i18n.get('date')}`, "url": text_day_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "text_day_pan.children[0].fill", "value": text_day_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //自定义文本1
            text_str1_pan = new Box({
                id: 'text_str1_pan',
                x: appvWidth / 2 - 200,
                y: appvHeight / 2 - 100,
                width: 350,
                height: 100,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        fontSize: 52.5,
                        fontWeight: 'black',
                        text: `自定义文字1`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "text_str1_pan",
                                "set": [
                                    { "name": `${i18n.get('Custom_text')}`, "url": text_str1_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_content')}`, "url": "text_str1_pan.children[0].text", "value": text_str1_pan.children[0].text, "type": "text", "tools": true },
                                    { "name": `${i18n.get('Text_color')}`, "url": "text_str1_pan.children[0].fill", "value": text_str1_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //自定义文本2
            text_str2_pan = new Box({
                id: 'text_str2_pan',
                x: appvWidth / 2 + 100,
                y: appvHeight / 2 - 100,
                width: 350,
                height: 100,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        fontSize: 52.5,
                        fontWeight: 'black',
                        text: `自定义文字2`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "text_str2_pan",
                                "set": [
                                    { "name": `${i18n.get('Custom_text')}`, "url": text_str2_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_content')}`, "url": "text_str2_pan.children[0].text", "value": text_str2_pan.children[0].text, "type": "text", "tools": true },
                                    { "name": `${i18n.get('Text_color')}`, "url": "text_str2_pan.children[0].fill", "value": text_str2_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //自定义文本3
            text_str3_pan = new Box({
                id: 'text_str3_pan',
                x: appvWidth / 2 - 200,
                y: appvHeight / 2 + 100,
                width: 350,
                height: 100,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        fontSize: 52.5,
                        fontWeight: 'black',
                        text: `自定义文字3`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "text_str3_pan",
                                "set": [
                                    { "name": `${i18n.get('Custom_text')}`, "url": text_str3_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_content')}`, "url": "text_str3_pan.children[0].text", "value": text_str3_pan.children[0].text, "type": "text", "tools": true },
                                    { "name": `${i18n.get('Text_color')}`, "url": "text_str3_pan.children[0].fill", "value": text_str3_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //自定义文本4
            text_str4_pan = new Box({
                id: 'text_str4_pan',
                x: appvWidth / 2 + 100,
                y: appvHeight / 2 + 100,
                width: 350,
                height: 100,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        fontSize: 52.5,
                        fontWeight: 'black',
                        text: `自定义文字4`,
                        fill: '#FFFFFF',
                        textAlign: 'left',
                        verticalAlign: 'top',
                    },
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "text_str4_pan",
                                "set": [
                                    { "name": `${i18n.get('Custom_text')}`, "url": text_str4_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_content')}`, "url": "text_str4_pan.children[0].text", "value": text_str4_pan.children[0].text, "type": "text", "tools": true },
                                    { "name": `${i18n.get('Text_color')}`, "url": "text_str4_pan.children[0].fill", "value": text_str4_pan.children[0].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //心率
            el_heart_pan = new Box({
                id: 'el_heart_pan',
                x: 100,
                y: 800,
                width: 200,
                height: 200,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        y: 50,
                        x: 100,
                        resizeFontSize: true,
                        fontSize: 64,
                        fontWeight: 'black',
                        text: `--`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Text',
                        y: 150,
                        x: 100,
                        resizeFontSize: true,
                        fontSize: 32,
                        fontWeight: 'black',
                        text: `bpm`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Ellipse',
                        width: 200,
                        height: 200,
                        startAngle: -210,
                        endAngle: 30,
                        innerRadius: 1,
                        stroke: "#CCCCCC",
                        strokeWidth: 24,
                        strokeWidthFixed: true,
                        strokeAlign: 'center',
                        strokeCap: 'round',
                    },
                    {
                        tag: 'Ellipse',
                        width: 200,
                        height: 200,
                        startAngle: -210,
                        endAngle: 30,
                        innerRadius: 1,
                        stroke: "#FF8C00",
                        strokeWidth: 24,
                        strokeWidthFixed: false,
                        strokeAlign: 'center',
                        strokeCap: 'round',
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "el_heart_pan",
                                "set": [
                                    { "name": `${i18n.get('heart_rate')}`, "url": el_heart_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "el_heart_pan.children[0].fill", "value": el_heart_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Unit_color')}`, "url": "el_heart_pan.children[1].fill", "value": el_heart_pan.children[1].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Graphic_backgrounds')}`, "url": "el_heart_pan.children[2].stroke", "value": el_heart_pan.children[2].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Graphic_color')}`, "url": "el_heart_pan.children[3].stroke", "value": el_heart_pan.children[3].stroke, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //配速
            el_pace_pan = new Box({
                id: 'el_pace_pan',
                x: 400,
                y: 800,
                width: 200,
                height: 200,
                lockRatio: true,
                editable: true,
                //fill: '#CCEEFF',
                cornerRadius: 4,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        y: 56,
                        x: 100,
                        resizeFontSize: true,
                        fontSize: 54,
                        fontWeight: 'black',
                        text: `--:--`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Text',
                        y: 150,
                        x: 100,
                        resizeFontSize: true,
                        fontSize: 32,
                        fontWeight: 'black',
                        text: `min/km`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Ellipse',
                        width: 200,
                        height: 200,
                        startAngle: -210,
                        endAngle: 30,
                        innerRadius: 1,
                        stroke: "#CCCCCC",
                        strokeWidth: 24,
                        strokeAlign: 'center',
                        strokeCap: 'round',
                    },
                    {
                        tag: 'Ellipse',
                        width: 200,
                        height: 200,
                        startAngle: -210,
                        endAngle: 30,
                        innerRadius: 1,
                        stroke: "#FF8C00",
                        strokeWidth: 24,
                        strokeAlign: 'center',
                        strokeCap: 'round',
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "el_pace_pan",
                                "set": [
                                    { "name": `${i18n.get('pace')}`, "url": el_pace_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "el_pace_pan.children[0].fill", "value": el_pace_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Unit_color')}`, "url": "el_pace_pan.children[1].fill", "value": el_pace_pan.children[1].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Graphic_backgrounds')}`, "url": "el_pace_pan.children[2].stroke", "value": el_pace_pan.children[2].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Graphic_color')}`, "url": "el_pace_pan.children[3].stroke", "value": el_pace_pan.children[3].stroke, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //步频
            el_cadence_pan = new Box({
                id: 'el_cadence_pan',
                x: 700,
                y: 800,
                width: 200,
                height: 200,
                lockRatio: true,
                editable: true,
                //fill: '#CCEEFF',
                cornerRadius: 4,//圆角
                hitBox: true,
                resizeChildren: true,//子元素是否跟随 resize
                children: [
                    {
                        tag: 'Text',
                        y: 50,
                        x: 100,
                        resizeFontSize: true,
                        fontSize: 64,
                        fontWeight: 'black',
                        text: `--`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Text',
                        y: 150,
                        x: 100,
                        resizeFontSize: true,
                        fontSize: 32,
                        fontWeight: 'black',
                        text: `step/min`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Ellipse',
                        width: 200,
                        height: 200,
                        startAngle: -210,
                        endAngle: 30,
                        innerRadius: 1,
                        stroke: "#CCCCCC",
                        strokeWidth: 24,
                        strokeAlign: 'center',
                        strokeCap: 'round',
                    },
                    {
                        tag: 'Ellipse',
                        width: 200,
                        height: 200,
                        startAngle: -210,
                        endAngle: 30,
                        innerRadius: 1,
                        stroke: "#FF8C00",
                        strokeWidth: 24,
                        strokeAlign: 'center',
                        strokeCap: 'round',
                    }
                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "el_cadence_pan",
                                "set": [
                                    { "name": `${i18n.get('cadence')}`, "url": el_cadence_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Text_color')}`, "url": "el_cadence_pan.children[0].fill", "value": el_cadence_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Unit_color')}`, "url": "el_cadence_pan.children[1].fill", "value": el_cadence_pan.children[1].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Graphic_backgrounds')}`, "url": "el_cadence_pan.children[2].stroke", "value": el_cadence_pan.children[2].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Graphic_color')}`, "url": "el_cadence_pan.children[3].stroke", "value": el_cadence_pan.children[3].stroke, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //距离进度条
            l_distance_pan = new Box({
                id: 'l_distance_pan',
                x: appvWidth / 2 - 500,
                y: 20,
                width: 1000,
                height: 200,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,
                children: [
                    {
                        tag: 'Rect',
                        width: 1000,
                        height: 50,
                        x: 0,
                        y: 0,
                        fill: '#191970',
                        cornerRadius: 20
                    },
                    {
                        tag: 'Line',
                        width: 0,
                        x: 90,
                        y: 25,
                        StrokeCap: 'round',
                        strokeWidth: 25,
                        stroke: '#FFCC00',
                    },
                    {
                        tag: 'Line',
                        width: 800,
                        x: 90,
                        y: 25,
                        strokeWidth: 30,
                        stroke: '#FFFFFF',
                        dashPattern: [2, 8]
                    },
                    {
                        tag: 'Line',
                        width: 800,
                        x: 90,
                        y: 25,
                        strokeWidth: 40,
                        stroke: '#FFFFFF',
                        dashPattern: [3, 97]
                    },
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 90,
                        x: 5,
                        y: 10,
                        fontSize: 20,
                        fontWeight: 'black',
                        text: `Start`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 110,
                        x: 880,
                        y: 10,
                        fontSize: 20,
                        fontWeight: 'black',
                        text: max_distance_in_km + `Km`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Polygon',
                        width: 20,
                        height: 20,
                        sides: 3,
                        x: 120,
                        y: 50,
                        fill: '#FF0000',
                    },
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        x: 120,
                        y: 62,
                        fontSize: 20,
                        fontWeight: 'black',
                        text: `--Km`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },


                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "l_distance_pan",
                                "set": [
                                    { "name": `${i18n.get('distancewide')}`, "url": l_distance_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Background_color')}`, "url": "l_distance_pan.children[0].fill", "value": l_distance_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('progress_color')}`, "url": "l_distance_pan.children[1].stroke", "value": l_distance_pan.children[1].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Ruler_color1')}`, "url": "l_distance_pan.children[2].stroke", "value": l_distance_pan.children[2].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Ruler_color2')}`, "url": "l_distance_pan.children[3].stroke", "value": l_distance_pan.children[3].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Start_color')}`, "url": "l_distance_pan.children[4].fill", "value": l_distance_pan.children[4].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('End_color')}`, "url": "l_distance_pan.children[5].fill", "value": l_distance_pan.children[5].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Locator_color')}`, "url": "l_distance_pan.children[6].fill", "value": l_distance_pan.children[6].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Current_value_color')}`, "url": "l_distance_pan.children[7].fill", "value": l_distance_pan.children[7].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })

            //雷达图
            el_leida_pan = new Box({
                id: 'el_leida_pan',
                x: appvWidth / 2 - 500,
                y: 500,
                width: 300,
                height: 300,
                lockRatio: true,
                editable: true,
                hitBox: true,
                resizeChildren: true,
                children: [
                    {
                        tag: 'Ellipse',
                        width: 200,
                        height: 200,
                        x: 40,
                        y: 40,
                        fill: '#FF4500',
                    },
                    {
                        tag: 'Ellipse',
                        width: 150,
                        height: 150,
                        x: 65,
                        y: 65,
                        fill: '#4682B4',
                    },
                    {
                        tag: 'Ellipse',
                        width: 100,
                        height: 100,
                        x: 90,
                        y: 90,
                        fill: '#98FB98',
                    },
                    {
                        tag: 'Line',
                        rotation: -90,
                        width: 100,
                        x: 140,
                        y: 140,
                        strokeWidth: 3,
                        stroke: '#FFFFFF',
                        dashPattern: [3, 3]
                    },
                    {
                        tag: 'Line',
                        rotation: 30,
                        width: 100,
                        x: 140,
                        y: 140,
                        strokeWidth: 3,
                        stroke: '#FFFFFF',
                        dashPattern: [3, 3]
                    },
                    {
                        tag: 'Line',
                        rotation: -210,
                        width: 100,
                        x: 140,
                        y: 140,
                        strokeWidth: 3,
                        stroke: '#FFFFFF',
                        dashPattern: [3, 3]
                    },
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 90,
                        x: 90,
                        y: 0,
                        fontSize: 30,
                        fontWeight: 'black',
                        text: `speed`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 110,
                        x: -40,
                        y: 190,
                        fontSize: 30,
                        fontWeight: 'black',
                        text: `heart`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    }, {
                        tag: 'Text',
                        resizeFontSize: true,
                        width: 130,
                        x: 200,
                        y: 190,
                        fontSize: 30,
                        fontWeight: 'black',
                        text: `cad`,
                        fill: '#FFFFFF',
                        textAlign: 'center',
                        verticalAlign: 'top',
                    },
                    {
                        tag: 'Polygon',
                        lockRatio: true,
                        points: [10, 90, 10, 10, 50, 70],
                        opacity: 0.7,
                        fill: '#FFA500',
                    },

                ],
                event: {
                    [PointerEvent.DOWN]: [
                        function () {
                            var json =
                            {
                                "id": "el_leida_pan",
                                "set": [
                                    { "name": `${i18n.get('leida')}`, "url": el_leida_pan.children[0].id, "value": "", "type": "title", "tools": false },
                                    { "name": `${i18n.get('Background_color')}`, "url": "el_leida_pan.children[0].fill", "value": el_leida_pan.children[0].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Background_color')}`, "url": "el_leida_pan.children[1].fill", "value": el_leida_pan.children[1].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Background_color')}`, "url": "el_leida_pan.children[2].fill", "value": el_leida_pan.children[2].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Background_color')}`, "url": "el_leida_pan.children[3].stroke", "value": el_leida_pan.children[3].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Background_color')}`, "url": "el_leida_pan.children[4].stroke", "value": el_leida_pan.children[4].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Background_color')}`, "url": "el_leida_pan.children[5].stroke", "value": el_leida_pan.children[5].stroke, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Text_color')}`, "url": "el_leida_pan.children[6].fill", "value": el_leida_pan.children[6].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Text_color')}`, "url": "el_leida_pan.children[7].fill", "value": el_leida_pan.children[7].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('Text_color')}`, "url": "el_leida_pan.children[8].fill", "value": el_leida_pan.children[8].fill, "type": "color", "tools": true },
                                    { "name": `${i18n.get('leida_color')}`, "url": "el_leida_pan.children[9].fill", "value": el_leida_pan.children[9].fill, "type": "color", "tools": true },
                                ]
                            }
                            tosettable(json);
                        }
                    ],
                },
            })


            //默认画布容器
            frame = new Frame({
                width: appvWidth,
                height: appvHeight,
                overflow: 'hide',
                //draggable: true,
                fill: '#000000'
            })
            appview.tree.add(frame);
            frame.add(appv_bg_pan);

            //缩放到合适位置
            //appview.tree.zoom(0.5);
            if (appvWidth > appvHeight) {
                appview.tree.zoom({ x: 0, y: 0, width: appvWidth, height: appvHeight }, [0, 0, 0, 0])
            } else {
                appview.tree.zoom({ x: 0, y: 0, width: appvWidth, height: appvHeight }, [0, -0, 0, 0])
            }


        }

        //添加默认模板
        function set_d_style() {
            frame.add(appv_nowtime_pan);
            frame.add(appv_distance_pan);
            frame.add(appv_map_pan);
            frame.add(appv_date_pan);
            frame.add(appv_metrics_pan);
            frame.add(appv_ele_pan);
            frame.add(appv_ele18_pan);
            frame.add(appv_nowstatus_pan);
            frame.add(appv_lap_pan);

            frame.add(TO_pace_pan);
            frame.add(TO_heart_pan);
            frame.add(TO_cadence_pan);
            frame.add(TO_step_pan);
            frame.add(TO_gps_pan);

            frame.add(text_time_pan);
            frame.add(text_nowtime_pan);
            frame.add(text_day_pan);

            frame.add(el_heart_pan);
            frame.add(el_pace_pan);
            frame.add(el_cadence_pan);

            frame.add(l_distance_pan);

            frame.add(text_str1_pan);
            frame.add(text_str2_pan);
            frame.add(text_str3_pan);
            frame.add(text_str4_pan);

            frame.add(el_leida_pan);

            frame.add(web_map_pan);
        }

        //生成视频
        generate.onclick = async function () {
            // 假设bl是倍率变量
            var bl = 2;
            // 构造器，和音视频编码对象
            var muxer = null;
            var videoEncoder = null;
            // 结束编码
            const endEncoding = async () => {
                await videoEncoder?.flush();
                muxer.finalize();
                let buffer = muxer.target?.buffer;
                var blobUrl = URL.createObjectURL(new Blob([buffer]));
                video.src = blobUrl;
                download.href = blobUrl;
                videoEncoder = null;
                muxer = null;
            };


            var canvas = document.getElementById('canv');
            var ctx = canvas.getContext('2d');
            // 清空整个canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 构造包装器
            muxer = new Mp4Muxer.Muxer({
                target: new Mp4Muxer.ArrayBufferTarget(),
                video: {
                    codec: 'avc',
                    width: canvWidth,
                    height: canvHeight
                },
                fastStart: 'in-memory',
                firstTimestampBehavior: 'offset'
            });
            // 音视频编码器，这里使用的是WebCodese API
            videoEncoder = new VideoEncoder({
                output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),
                error: e => console.error(e)
            });
            videoEncoder.configure({
                codec: 'avc1.42403e',//编码器级别
                width: canvWidth,
                height: canvHeight,
                bitrate: 10e6//质量
            });
            var frameCounter = 0;//祯计数器
            var currentFrame = 0;//运动数据长度计数器
            //currentFrame = maxFrame - 5;
            //制作视频，插入帧
            function updateFrame() {
                //判断是否有地图
                if (frame.find('#web_map_pan').length > 0 || frame.find('#web_minimap_pan').length > 0) {
                    var now_frame_delay = frame_delay * 1 + 0;
                } else {
                    var now_frame_delay = frame_delay * 1;
                }
                //if (currentFrame < 1000) {maxFrame
                //

                if (currentFrame < maxFrame) {

                    if (upFrame(currentFrame)) {
                        frameTocanv();
                        let frame = new VideoFrame(canvas, {
                            timestamp: (trkpt_data[currentFrame].sec * 1e6),

                            //duration: (1e6 * 5) ,
                        });
                        //console.log('Timestamp:', trkpt_data[currentFrame].timestamp);
                        // if (currentFrame == 0) {
                        //     console.log('Timestamp:', frame); // 打印timestamp信息
                        // }
                        frameCounter++;
                        videoEncoder.encode(frame, {
                            keyFrame: trkpt_data[currentFrame].sec % 5 === 0
                        });
                        frame.close();
                        currentFrame++;
                        //循环
                        timerId = setTimeout(updateFrame, now_frame_delay);//now_frame_delay延时
                    }

                } else {
                    // 最后一帧
                    upFrame(maxFrame - 1);
                    console.log(maxFrame - 1);
                    frameTocanv();
                    let frame = new VideoFrame(canvas, {
                        timestamp: (trkpt_data[maxFrame - 1].sec + 1) * 1e6
                    });
                    videoEncoder.encode(frame, {
                        keyFrame: true //整秒关键祯 true
                    });
                    //console.log('Timestamp1:', trkpt_data[maxFrame-1].timestamp);

                    frame.close();

                    //关闭录制
                    endEncoding();
                    clearTimeout(timerId);
                    $('#view_info').css('display', 'none');

                }
            }
            // 启动定时更新
            updateFrame();
        }



        // 更新编辑事件，json部件点击事件
        function tosettable(json) {
            const settableDiv = document.getElementById('settable');
            settableDiv.innerHTML = ''; // 清空现有内容

            json.set.forEach(item => {
                const div = document.createElement('div');
                div.className = 'layui-form-item';

                const label = document.createElement('label');
                label.className = 'layui-form-label';
                label.textContent = item.name;
                div.appendChild(label);

                const inputDiv = document.createElement('div');
                inputDiv.className = 'layui-input-block';

                switch (item.type) {
                    case 'title':
                        if (!item.tools) {
                            const title = document.createElement('div');
                            title.className = 'layui-form-mid layui-word-aux';
                            title.textContent = item.value;
                            inputDiv.appendChild(title);
                        }
                        if (item.name != `${i18n.get('Canvas_settings')}`) {
                            // 添加移除按钮
                            const removeButton = document.createElement('button');
                            removeButton.textContent = `${i18n.get('remove')}`;
                            removeButton.className = 'layui-btn layui-btn-danger layui-btn-sm';
                            removeButton.onclick = function () {
                                // 执行移除操作
                                new Function(json.id + '.remove();')();
                                interaction.pointerDown({ x: 0, y: 0 });
                                interaction.pointerUp();
                                settableDiv.innerHTML = ''; // 清空现有内容
                            };
                            inputDiv.appendChild(removeButton);
                        }
                        break;
                    case 'number':
                        const numberInput = document.createElement('input');
                        numberInput.type = 'number';
                        numberInput.value = item.value;
                        numberInput.className = 'layui-input';
                        numberInput.onchange = function () {
                            new Function('value', 'window.' + item.url + ' = value;')(Number(this.value));
                        };
                        inputDiv.appendChild(numberInput);
                        break;
                    case 'Ellipse':
                        const EllipseInput = document.createElement('input');
                        EllipseInput.type = 'number';
                        EllipseInput.value = item.value;
                        EllipseInput.className = 'layui-input';
                        EllipseInput.onchange = function () {
                            new Function('value', 'window.' + item.url + '.width = value;')(Number(this.value));
                            new Function('value', 'window.' + item.url + '.height = value;')(Number(this.value));
                        };
                        inputDiv.appendChild(EllipseInput);
                        break;
                    case 'color':
                        const colorInput = document.createElement('input');
                        colorInput.type = 'color';
                        colorInput.value = item.value;
                        colorInput.className = 'layui-input';
                        colorInput.onchange = function () {
                            new Function('value', 'window.' + item.url + ' = value;')(this.value);
                        };
                        inputDiv.appendChild(colorInput);
                        break;

                    case 'funcolor':
                        const funcolorInput = document.createElement('input');
                        funcolorInput.type = 'color';
                        funcolorInput.value = item.value;
                        funcolorInput.className = 'layui-input';
                        funcolorInput.onchange = function () {
                            const updateSymbolFunction = new Function('value', item.url);
                            // 调用创建的函数，并传递当前输入框的值
                            updateSymbolFunction(this.value);
                            setTimeout(getProgressBarValueAndUpdate, 20);
                        };
                        inputDiv.appendChild(funcolorInput);
                        break;

                    case 'funnumber':
                        const funnumberInput = document.createElement('input');
                        funnumberInput.type = 'number';
                        funnumberInput.value = item.value;
                        funnumberInput.className = 'layui-input';
                        funnumberInput.onchange = function () {
                            const updateSymbolFunction = new Function('value', item.url);
                            // 调用创建的函数，并传递当前输入框的值
                            updateSymbolFunction(this.value);
                            setTimeout(getProgressBarValueAndUpdate, 20);
                        };
                        inputDiv.appendChild(funnumberInput);
                        break;
                    case 'text':
                        const textInput = document.createElement('input'); // 创建文本输入框
                        textInput.type = 'text'; // 设置类型为文本
                        textInput.value = item.value; // 同样修正了拼写错误
                        textInput.className = 'layui-input';
                        textInput.onchange = function () {
                            new Function('value', 'window.' + item.url + ' = value;')(this.value);
                        };
                        inputDiv.appendChild(textInput);
                        break;
                }

                div.appendChild(inputDiv);
                settableDiv.appendChild(div);
            });
        }

        //将画布更新到容器
        function frameTocanv() {
            frame.export('canvas').then(result => {
                const leaferCanvas = result.data;
                const canvas = leaferCanvas.view;
                const context = leaferCanvas.context;
                // 获取目标canvas元素
                const targetCanvas = document.getElementById('canv');
                // 设置目标canvas的宽高
                targetCanvas.width = appvWidth;
                targetCanvas.height = appvHeight;
                // 获取目标canvas的2d上下文
                const targetContext = targetCanvas.getContext('2d');
                // 将图像绘制到目标canvas上
                targetContext.drawImage(canvas, 0, 0, targetCanvas.width, targetCanvas.height);
            });

        }

        //更新画布
        function upFrame(currentFrame) {

            // 给view_info的文本赋值，转换进度
            $('#view_info').html(currentFrame.toString() + '/' + maxFrame.toString());

            //开始填充
            // 获取trkpt_data数组中最后一个元素的distance属性值，除以1000后进行四舍五入保留两位小数

            //zcd.text = max_distance_in_km + `Km`;//总长度
            let distance_in_km = Math.round(trkpt_data[currentFrame].distance / 1000 * 100) / 100;
            //console.log(currentFrame, distance_in_km);
            appv_distance_pan.children[2].text = distance_in_km + `Km`;//行进长度

            var jdtcd = (trkpt_data[currentFrame].distance / trkpt_data[maxFrame - 1].distance) * appv_distance_pan.children[3].width;//计算实时长度
            appv_distance_pan.children[4].width = jdtcd;
            //长进度条l_distance_pan
            l_distance_pan.children[7].text = distance_in_km + `Km`;//行进长度

            //距离条
            var jdtcd = (trkpt_data[currentFrame].distance / trkpt_data[maxFrame - 1].distance) * l_distance_pan.children[2].width;//计算实时长度
            l_distance_pan.children[1].width = jdtcd;
            l_distance_pan.children[6].x = jdtcd + 80;
            l_distance_pan.children[7].x = jdtcd + 90;

            //设置高程
            appv_ele18_pan.children[1].x = ele18_points[2 * currentFrame] - 6;
            appv_ele18_pan.children[1].y = ele18_points[2 * currentFrame + 1] - 6;

            appv_ele_pan.children[1].x = ele_points[2 * currentFrame];

            // 获取高程，若不存在则设为0
            //let altitude = trkpt_data[currentFrame] && trkpt_data[currentFram].step_length ? trkpt_data[currentFrame].altitude : 0;

            //当前进行时间 var now_time_str = secondsToHHMMSS(trkpt_data[currentFrame].sec);
            appv_nowtime_pan.children[0].text = secondsToHHMMSS(trkpt_data[currentFrame].sec);
            text_nowtime_pan.children[0].text = secondsToHHMMSS(trkpt_data[currentFrame].sec);





            //画地图
            var now_points = [];
            for (let index = 0; index <= currentFrame; index++) {
                //画经过路线
                now_points.push(map_points[index * 2]);   // 第一个数值乘以2
                now_points.push(map_points[index * 2 + 1]); // 第二个数值乘以2

            }
            appv_map_pan.children[1].points = now_points;



            //画web地图
            if (frame.find('#web_map_pan').length > 0 || frame.find('#web_minimap_pan').length > 0) {
                daohang(currentFrame);
                if (frame.find('#web_map_pan').length > 0) {
                    const mapCanvas = document.querySelector("#leafletmap > div > div.maptalks-all-layers > div.maptalks-canvas-layer > canvas");
                    web_map_pan.children[0].context.drawImage(mapCanvas, 0, 0, web_map_pan.children[0].width, web_map_pan.children[0].height);
                    web_map_pan.children[0].paint()
                }
                if (frame.find('#web_minimap_pan').length > 0) {
                    const minimapCanvas = document.querySelector("#leafletmap_mini > div > div.maptalks-all-layers > div.maptalks-canvas-layer > canvas");
                    web_minimap_pan.children[0].context.drawImage(minimapCanvas, 0, 0, web_minimap_pan.children[0].width, web_minimap_pan.children[0].height);
                    web_minimap_pan.children[0].paint()
                }
            }

            //画当前点
            appv_map_pan.children[2].x = map_points[currentFrame * 2] - 8;
            appv_map_pan.children[2].y = map_points[currentFrame * 2 + 1] - 8;
            //当前经纬度
            TO_gps_pan.children[0].text = `${convertToDegreeMinuteSecond(trkpt_data[currentFrame].position_lat)}\n${convertToDegreeMinuteSecond(trkpt_data[currentFrame].position_long)}`;



            //当前状态
            // 获取速度，若不存在则设为0
            let speed = trkpt_data[currentFrame] && trkpt_data[currentFrame].speed ? trkpt_data[currentFrame].speed : 0;
            let pace;
            if (speed > 0) {
                let pace_in_minutes = 60 / speed;  // 先计算配速对应的分钟数
                let minutes = Math.floor(pace_in_minutes);  // 取整得到分钟数
                let seconds = Math.floor((pace_in_minutes - minutes) * 60);  // 计算剩余的秒数
                pace = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;  // 格式化为mm:ss格式
            } else {
                pace = "00:00";
            }

            // 获取心率，若不存在则设为0
            let count = trkpt_data[currentFrame] && trkpt_data[currentFrame].heart_rate ? trkpt_data[currentFrame].heart_rate : 0;
            // 获取步频，若不存在则设为0
            let cadence = trkpt_data[currentFrame] && trkpt_data[currentFrame].cadence ? trkpt_data[currentFrame].cadence : 0;
            // 获取步幅，若不存在则设为0
            let step_length = trkpt_data[currentFrame] && trkpt_data[currentFrame].step_length ? trkpt_data[currentFrame].step_length : 0;


            //雷达图
            let flatPoints = to_leida_xy(count, speed, cadence);
            el_leida_pan.children[9].points = flatPoints;

            //综合
            appv_nowstatus_pan.children[0].text = `${i18n.get('speed')}：${speed.toFixed(2)} km/h\n${i18n.get('pace')}：${pace} min/km\n${i18n.get('heart_rate')}：${count} bpm\n${i18n.get('cadence')}：${cadence} steps/min\n${i18n.get('step_length')}：${step_length} m`;
            //to仪表盘
            TO_pace_pan.children[0].text = `${pace} min/km`;
            TO_heart_pan.children[0].text = `${count} bpm`;
            TO_cadence_pan.children[0].text = `${cadence} steps/min`;
            TO_step_pan.children[0].text = `${step_length} m`;

            //心率仪表盘
            el_heart_pan.children[0].text = `${count}`;
            //max220,min40，系数1.33
            if (count < 40) {
                count = 40;
            }
            el_heart_pan.children[3].endAngle = -210 + (count - 40) * 1.33;

            //配速仪表盘
            el_pace_pan.children[0].text = `${pace}`;
            //max22，min0，系数10.9
            el_pace_pan.children[3].endAngle = -210 + speed * 10.9;

            //步频仪表盘
            el_cadence_pan.children[0].text = `${cadence}`;





            //max240，min0，系数1
            el_cadence_pan.children[3].endAngle = -210 + cadence * 1;

            //圈速
            let segment_info = "";
            let lap = "";
            // 计算已经完成的整公里数
            let completed_km = Math.floor(trkpt_data[currentFrame].distance / 1000);
            for (let km = 1; km <= completed_km; km++) {
                if (km % 5 === 0 && km > 0) {
                    // 如果是10的倍数（大于0），按照每5km一条的规则来展示
                    let startKm = km - 4;
                    let endKm = km;
                    let totalTimeInSeconds = 0;
                    for (let i = startKm - 1; i < endKm; i++) {
                        if (i < json_data.lap_standard.length) {
                            totalTimeInSeconds += json_data.lap_standard[i].total_timer_time;
                        }
                    }
                    let minutes = Math.floor(totalTimeInSeconds / 60);
                    let seconds = Math.floor(totalTimeInSeconds % 60);

                    lap += `${startKm}-${endKm}km${i18n.get('nowtime')}：${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}\n`;
                    segment_info = lap;
                } else {
                    let time_in_seconds = km - 1 < json_data.lap_standard.length ? json_data.lap_standard[km - 1].total_timer_time : 0;
                    let minutes = Math.floor(time_in_seconds / 60);
                    let seconds = Math.floor(time_in_seconds % 60);
                    segment_info += `${km}km${i18n.get('nowtime')}：${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}\n`;
                }
            }

            // 圈速
            appv_lap_pan.children[0].text = segment_info;

            //综合图表画进度 metrics
            appv_metrics_pan.children[3].x = appv_metrics_pan.width / maxFrame * currentFrame;

            //当前日期时间
            appv_date_pan.children[0].text = timestampToDateString(trkpt_data[currentFrame].timestamp);

            //当前时间
            text_time_pan.children[0].text = timestampToDateString(trkpt_data[currentFrame].timestamp, 0);

            //当前日期
            text_day_pan.children[0].text = timestampToDateString(trkpt_data[currentFrame].timestamp, 1);

            return true;
        }

        //将一个表示秒数的整数转换为 HH:MM:SS 的格式
        function secondsToHHMMSS(seconds) {
            var hours = Math.floor(seconds / 3600);
            var minutes = Math.floor((seconds % 3600) / 60);
            var seconds = seconds % 60;
            // Pad the hours, minutes and seconds with leading zeros, if required
            hours = hours.toString().padStart(2, '0');
            minutes = minutes.toString().padStart(2, '0');
            seconds = seconds.toString().padStart(2, '0');
            return hours + ':' + minutes + ':' + seconds;
        }

        // 地图转换
        function mapToRange(value, fromMin, fromMax, toMin, toMax) {
            return (value - fromMin) * (toMax - toMin) / (fromMax - fromMin) + toMin;
        }

        //时间转换函数
        function timestampToDateString(timestamp, type) {
            const date = new Date(timestamp * 1000); // JavaScript中的时间戳是以毫秒为单位的
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // 月份是从0开始的
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            // 返回格式化的日期字符串
            if (type == 0) {
                return `${hours}:${minutes}:${seconds}`;
            } else if (type == 1) {
                return `${year}-${month}-${day}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            }
        }

        //经纬度转换为度分秒格式
        function convertToDegreeMinuteSecond(latOrLon) {
            // 取绝对值进行计算
            const value = Math.abs(latOrLon);
            // 度
            const degrees = Math.floor(value);
            // 分
            const minutes = Math.floor((value - degrees) * 60);
            // 秒
            const seconds = Math.round((value - degrees - minutes / 60) * 3600 * 100) / 100;
            // 判断是经度还是纬度，并确定方向
            const direction = latOrLon >= 0 ? (latOrLon > 90 ? 'E' : 'N') : (latOrLon < -90 ? 'W' : 'S');
            // 返回格式化的度分秒字符串
            return `${degrees}°${minutes}'${seconds}"${direction}`;
        }

        // 解析GPX，gpxParser是已经定义好的GPX解析器类
        function gpxToJson(gpxContent) {
            let rq = {
                "status": 0,
                "data": {
                    "summary": { //概况
                        "name": "",//标题
                        "total_time": 0,//总时长
                        "training_at": "",//时间
                        "total_timer_time": 0,//总时长
                    },
                    "motion": {	//运动
                        "distance": 0,//训练路程 米1
                        "total_ascent": 0,//总爬升
                        "total_descent": 0,//总下降
                    },
                    "trkpt": [],
                    "lap_standard": []
                }
            };
            const gpx = new gpxParser(); // 创建gpxParser实例
            gpx.parse(gpxContent); // 解析GPX内容
            console.log(gpx);
            //第一个时间
            var firstPointTime = new Date(gpx.tracks[0].points[0].time).getTime();
            //var firstPointTime = new Date(gpx.metadata.time).getTime();
            // 初始化变量来存储步频的总和和计数
            let cadenceSum = 0;
            let cadenceCount = 0;
            for (let i = 0; i < gpx.tracks[0].points.length; i++) {
                var currentPoint = gpx.tracks[0].points[i];
                var sec = (new Date(currentPoint.time).getTime() - firstPointTime) / 1000;
                //console.log(sec);
                var timeCurrent = new Date(currentPoint.time).getTime() / 1000;
                var previoustimeCurrent = 0;
                let distanceCurrent = 0;
                let speed = 0;
                let cadenceCorrected = currentPoint.cad;//步频
                // 调整累积距离的索引
                if (i > 0) {
                    distanceCurrent = gpx.tracks[0].distance.cumul[i - 1]; // 当前点的累积距离，索引减1
                    previoustimeCurrent = new Date(gpx.tracks[0].points[i - 1].time).getTime() / 1000;
                }
                //速度
                if (gpx.metadata && gpx.metadata.link && gpx.metadata.link.text === "COROS" && gpx.currentPoint && gpx.currentPoint.speed) {
                    speed = currentPoint.speed * 3600 / 1000;

                }else{//计算
                    // 计算前后点的速度
                    if (i > 0 && i < gpx.tracks[0].points.length - 1) {
                        // 不是第一个点也不是最后一个点
                        var previousPoint = gpx.tracks[0].points[i - 1];
                        var nextPoint = gpx.tracks[0].points[i + 1];
                        var timePrevious = new Date(previousPoint.time).getTime() / 1000;
                        var timeNext = new Date(nextPoint.time).getTime() / 1000;
                        var distancePrevious = i > 1 ? gpx.tracks[0].distance.cumul[i - 1] : 0; // 前一个点的累积距离，索引减2
                        var distanceNext = gpx.tracks[0].distance.cumul[i + 1]; // 后一个点的累积距离，索引不变
                        // 计算前后两个点的速度
                        var speedPrevious = (distanceCurrent - distancePrevious) / (timeCurrent - timePrevious);
                        var speedNext = (distanceNext - distanceCurrent) / (timeNext - timeCurrent);
                        // 计算平均速度
                        speed = (speedPrevious + speedNext) / 2;
                    } else if (i == 0) {
                        // 第一个点
                        speed = 0;
                    } else if (i == gpx.tracks[0].points.length - 1) {
                        // 最后一个点，无法计算速度，因为后一个点已经被抛弃
                        // 可以选择忽略或者设置速度为0
                        speed = 0;
                    }
                    // 将速度转换为公里/小时
                    speed = speed * 3.6;
                }




                // 累加步频并计数
                cadenceSum += currentPoint.cad;
                cadenceCount++;
                // 计算步频的平均值
                var cadenceAverage = cadenceSum / cadenceCount;
                // 如果步频平均值低于140，则乘以2
                if (cadenceAverage < 140) {
                    cadenceCorrected = cadenceCorrected * 2;
                }
                // 计算步幅
                let stepLength = 0;
                if (cadenceCorrected > 0) {
                    // 将步频从步/分钟转换为步/秒
                    //var cadencePerSecond = cadenceCorrected / 60 / 3;
                    // 步幅 = 速度（km每小时） / 步频（步/秒）
                    stepLength = (speed * 1000) / (cadenceCorrected * 60);
                    //console.log(speed * 1000 , cadenceCorrected*60);
                }
                //赋值
                let newPoint = {
                    timestamp: timeCurrent,
                    sec: sec,
                    position_lat: currentPoint.lat,
                    position_long: currentPoint.lon,
                    altitude: currentPoint.ele,
                    is_pause: false,
                    speed: parseFloat(speed.toFixed(2)), // 更新速度
                    distance: parseFloat(distanceCurrent.toFixed(2)),
                    heart_rate: currentPoint.hr,
                    cadence: cadenceCorrected,
                    step_length: parseFloat(stepLength.toFixed(2))
                };
                rq.data.trkpt.push(newPoint);//分段数据

            }
            rq.data.summary.name = gpx.tracks[0].name;//运动标题
            // 转换"2024-11-23T07:01:13.000Z"
            //let timeStr = gpx.metadata.time;
            let timeStr = gpx.tracks[0].points[0].time;
            let date = new Date(timeStr);
            let formattedTime = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
            rq.data.summary.training_at = formattedTime; // 训练时间
            rq.data.summary.total_time = sec; //训练时长
            rq.data.summary.total_timer_time = sec; //训练时长
            rq.data.motion.distance = parseFloat(gpx.tracks[0].distance.total.toFixed(2));//训练路程
            rq.data.motion.total_ascent = gpx.tracks[0].elevation.pos;//总爬升
            rq.data.motion.total_descent = gpx.tracks[0].elevation.neg;//总下降
            //计算每km用时
            // 假设rq对象已经定义好了，并且包含了所需的属性
            // 初始化变量
            let previousDistance = 0;
            let previousTimestamp = rq.data.trkpt.length > 0 ? rq.data.trkpt[0].timestamp : 0;
            let lapId = 0;
            // 遍历所有轨迹点
            for (let i = 0; i < rq.data.trkpt.length; i++) {
                let currentDistance = rq.data.trkpt[i].distance;
                let currentTimestamp = rq.data.trkpt[i].timestamp;
                // 计算距离差
                let distanceDiff = currentDistance - previousDistance;
                // 当距离差达到或超过1000米时，计算用时并存储
                while (distanceDiff >= 1000) {
                    // 计算用时（秒）
                    let totalTimerTime = currentTimestamp - previousTimestamp;
                    // 存储用时到lap_standard数组
                    rq.data.lap_standard.push({
                        id: lapId,
                        total_timer_time: totalTimerTime
                    });
                    // 更新变量
                    previousDistance += 1000;
                    previousTimestamp = currentTimestamp;
                    lapId++;
                    // 更新距离差
                    distanceDiff = currentDistance - previousDistance;
                }
            }
            // 注意：如果最后一个轨迹点的累计距离不是1000的整数倍，可能需要处理剩余的部分
            // 这里假设最后一个轨迹点已经处理过了，如果需要处理，可以添加相应的逻辑
            //console.log(rq);

            return rq; // 返回解析后的gpx对象，假设它已经被转换为JSON兼容格式
        }

        // 解析tcx，tcxParser是已经定义好的GPX解析器类
        function tcxToJson(tcxContent) {
            let rq = {
                "status": 0,
                "data": {
                    "summary": { //概况
                        "name": "",//标题
                        "total_time": 0,//总时长
                        "training_at": "",//时间
                        "total_timer_time": 0,//总时长
                    },
                    "motion": {	//运动
                        "distance": 0,//训练路程 米1
                        "total_ascent": 0,//总爬升
                        "total_descent": 0,//总下降
                    },
                    "trkpt": [],
                    "lap_standard": []
                }
            };
            const tcx = new tcxParser(); // 创建tcxParser实例
            tcx.parse(tcxContent); // 解析TCX内容
            console.log(tcx);
            //第一个时间
            var firstPointTime = new Date(tcx.tracks[0].points[0].time).getTime();
            //var firstPointTime = new Date(tcx.metadata.time).getTime();
            // 初始化变量来存储步频的总和和计数
            let cadenceSum = 0;
            let cadenceCount = 0;
            for (let i = 0; i < tcx.tracks[0].points.length; i++) {
                var currentPoint = tcx.tracks[0].points[i];
                var sec = (new Date(currentPoint.time).getTime() - firstPointTime) / 1000;
                //console.log(sec);
                var timeCurrent = new Date(currentPoint.time).getTime() / 1000;
                var previoustimeCurrent = 0;
                let distanceCurrent = 0;
                let speed = 0;
                let cadenceCorrected = currentPoint.cad;//步频
                // 调整累积距离的索引
                if (i > 0) {
                    distanceCurrent = tcx.tracks[0].distance.cumul[i - 1]; // 当前点的累积距离，索引减1
                    previoustimeCurrent = new Date(tcx.tracks[0].points[i - 1].time).getTime() / 1000;
                }
                // 计算前后点的速度
                if (i > 0 && i < tcx.tracks[0].points.length - 1) {
                    // 不是第一个点也不是最后一个点
                    var previousPoint = tcx.tracks[0].points[i - 1];
                    var nextPoint = tcx.tracks[0].points[i + 1];
                    var timePrevious = new Date(previousPoint.time).getTime() / 1000;
                    var timeNext = new Date(nextPoint.time).getTime() / 1000;
                    var distancePrevious = i > 1 ? tcx.tracks[0].distance.cumul[i - 1] : 0; // 前一个点的累积距离，索引减2
                    var distanceNext = tcx.tracks[0].distance.cumul[i + 1]; // 后一个点的累积距离，索引不变
                    // 计算前后两个点的速度
                    var speedPrevious = (distanceCurrent - distancePrevious) / (timeCurrent - timePrevious);
                    var speedNext = (distanceNext - distanceCurrent) / (timeNext - timeCurrent);
                    // 计算平均速度
                    speed = (speedPrevious + speedNext) / 2;
                } else if (i == 0) {
                    // 第一个点
                    speed = 0;
                } else if (i == tcx.tracks[0].points.length - 1) {
                    // 最后一个点，无法计算速度，因为后一个点已经被抛弃
                    // 可以选择忽略或者设置速度为0
                    speed = 0;
                }
                // 将速度转换为公里/小时
                speed = speed * 3.6;
                // 累加步频并计数
                cadenceSum += currentPoint.cad;
                cadenceCount++;
                // 计算步频的平均值
                var cadenceAverage = cadenceSum / cadenceCount;
                // 如果步频平均值低于140，则乘以2
                if (cadenceAverage < 140) {
                    cadenceCorrected = cadenceCorrected * 2;
                }
                // 计算步幅
                let stepLength = 0;
                if (cadenceCorrected > 0) {
                    // 将步频从步/分钟转换为步/秒
                    //var cadencePerSecond = cadenceCorrected / 60 / 3;
                    // 步幅 = 速度（km每小时） / 步频（步/秒）
                    stepLength = (speed * 1000) / (cadenceCorrected * 60);
                    //console.log(speed * 1000 , cadenceCorrected*60);
                }
                //赋值
                let newPoint = {
                    timestamp: timeCurrent,
                    sec: sec,
                    position_lat: currentPoint.lat,
                    position_long: currentPoint.lon,
                    altitude: currentPoint.ele,
                    is_pause: false,
                    speed: parseFloat(speed.toFixed(2)), // 更新速度
                    distance: parseFloat(distanceCurrent.toFixed(2)),
                    heart_rate: currentPoint.hr,
                    cadence: cadenceCorrected,
                    step_length: parseFloat(stepLength.toFixed(2))
                };
                rq.data.trkpt.push(newPoint);//分段数据

            }
            rq.data.summary.name = tcx.tracks[0].name;//运动标题
            // 转换"2024-11-23T07:01:13.000Z"
            //let timeStr = tcx.metadata.time;
            let timeStr = tcx.tracks[0].points[0].time;
            let date = new Date(timeStr);
            let formattedTime = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
            rq.data.summary.training_at = formattedTime; // 训练时间
            rq.data.summary.total_time = sec; //训练时长
            rq.data.summary.total_timer_time = sec; //训练时长
            rq.data.motion.distance = parseFloat(tcx.tracks[0].distance.total.toFixed(2));//训练路程
            rq.data.motion.total_ascent = tcx.tracks[0].elevation.pos;//总爬升
            rq.data.motion.total_descent = tcx.tracks[0].elevation.neg;//总下降
            //计算每km用时
            // 假设rq对象已经定义好了，并且包含了所需的属性
            // 初始化变量
            let previousDistance = 0;
            let previousTimestamp = rq.data.trkpt.length > 0 ? rq.data.trkpt[0].timestamp : 0;
            let lapId = 0;
            // 遍历所有轨迹点
            for (let i = 0; i < rq.data.trkpt.length; i++) {
                let currentDistance = rq.data.trkpt[i].distance;
                let currentTimestamp = rq.data.trkpt[i].timestamp;
                // 计算距离差
                let distanceDiff = currentDistance - previousDistance;
                // 当距离差达到或超过1000米时，计算用时并存储
                while (distanceDiff >= 1000) {
                    // 计算用时（秒）
                    let totalTimerTime = currentTimestamp - previousTimestamp;
                    // 存储用时到lap_standard数组
                    rq.data.lap_standard.push({
                        id: lapId,
                        total_timer_time: totalTimerTime
                    });
                    // 更新变量
                    previousDistance += 1000;
                    previousTimestamp = currentTimestamp;
                    lapId++;
                    // 更新距离差
                    distanceDiff = currentDistance - previousDistance;
                }
            }
            // 注意：如果最后一个轨迹点的累计距离不是1000的整数倍，可能需要处理剩余的部分
            // 这里假设最后一个轨迹点已经处理过了，如果需要处理，可以添加相应的逻辑
            //console.log(rq);

            return rq; // 返回解析后的gpx对象，假设它已经被转换为JSON兼容格式
        }

        // 解析fit
        function fitToJson(fitbyte) {
            let rq = {
                "status": 0,
                "data": {
                    "summary": { //概况
                        "name": "",//标题
                        "total_time": 0,//总时长
                        "training_at": "",//时间
                        "total_timer_time": 0,//总时长
                    },
                    "motion": {	//运动
                        "distance": 0,//训练路程 米1
                        "total_ascent": 0,//总爬升
                        "total_descent": 0,//总下降
                    },
                    "trkpt": [],
                    "lap_standard": []
                }
            };

            var fitParser = new FitParser({
                force: true,
                speedUnit: 'km/h',
                lengthUnit: 'km',
                temperatureUnit: 'celcius',
                elapsedRecordField: true,
                mode: 'list',                  //using 'cascade' or 'both' doesn't seem to work
            });

            fitParser.parse(fitbyte, function (error, data) {
                // Handle result of parse method
                if (error) {
                    console.log(error);
                } else {
                    console.log(data);
                    fit = data;
                }

            });


            //第一个时间
            var firstPointTime = new Date(fit.records[0].timestamp).getTime();
            //var firstPointTime = new Date(fit.metadata.time).getTime();
            // 初始化变量来存储步频的总和和计数
            let cadenceSum = 0;
            let cadenceCount = 0;
            let total_ascent = 0;
            let total_descent = 0;


            for (let i = 0; i < fit.records.length; i++) {
                var currentPoint = fit.records[i];
                var sec = currentPoint.elapsed_time;
                //console.log(sec);
                var timeCurrent = new Date(currentPoint.timestamp).getTime() / 1000;
                var previoustimeCurrent = 0;
                var distanceCurrent = currentPoint.distance * 1000;

                var speed = currentPoint?.enhanced_speed ?? currentPoint?.speed ?? 0;
                //console.log(speed);


                let cadenceCorrected = currentPoint.cadence;//步频

                // 将速度转换为公里/小时
                //speed = speed * 3.6;
                // 累加步频并计数
                cadenceSum += currentPoint.cadence;
                cadenceCount++;
                // 计算步频的平均值
                var cadenceAverage = cadenceSum / cadenceCount;
                // 如果步频平均值低于140，则乘以2
                if (cadenceAverage < 140) {
                    cadenceCorrected = cadenceCorrected * 2;
                }
                // 计算步幅
                let stepLength = 0;
                if (cadenceCorrected > 0) {
                    // 将步频从步/分钟转换为步/秒
                    //var cadencePerSecond = cadenceCorrected / 60 / 3;
                    // 步幅 = 速度（km每小时） / 步频（步/秒）
                    stepLength = (speed * 1000) / (cadenceCorrected * 60);

                }

                // 上升和下降
                let currentAltitude = fit.records[i].enhanced_altitude !== undefined ? fit.records[i].enhanced_altitude : fit.records[i].altitude;

                if (i === 0) {
                    var previousAltitude = fit.records[i].enhanced_altitude !== undefined ? fit.records[i].enhanced_altitude : fit.records[i].altitude;
                } else {
                    var previousAltitude = fit.records[i - 1].enhanced_altitude !== undefined ? fit.records[i - 1].enhanced_altitude : fit.records[i - 1].altitude;
                }


                if (currentAltitude > previousAltitude) {
                    total_ascent += currentAltitude - previousAltitude;
                } else if (currentAltitude < previousAltitude) {
                    total_descent += previousAltitude - currentAltitude;
                }

                //fit修正，防止第一个和最后一个gps打点为空，高驰
                let position_lat;
                let position_long;

                if (i === fit.records.length - 1) {
                    // 如果是最后一个元素，则取前一个
                    position_lat = currentPoint.position_lat ?? fit.records[i - 1].position_lat ?? 0;
                    position_long = currentPoint.position_long ?? fit.records[i - 1].position_long ?? 0;
                } else {
                    // 否则，取后一个
                    position_lat = currentPoint.position_lat ?? fit.records[i + 1].position_lat ?? 0;
                    position_long = currentPoint.position_long ?? fit.records[i + 1].position_long ?? 0;
                }


                //赋值
                let newPoint = {
                    timestamp: timeCurrent,
                    sec: sec,
                    position_lat: position_lat,
                    position_long: position_long,
                    altitude: parseFloat(
                        ((currentPoint.enhanced_altitude !== undefined
                            ? currentPoint.enhanced_altitude
                            : (currentPoint.altitude !== undefined ? currentPoint.altitude : 0)) * 1000).toFixed(2)
                    ),

                    is_pause: false,
                    speed: parseFloat(speed.toFixed(2)), // 更新速度
                    distance: parseFloat(distanceCurrent.toFixed(2)),
                    heart_rate: currentPoint.heart_rate ?? 0,
                    cadence: cadenceCorrected,
                    step_length: parseFloat(stepLength.toFixed(2))
                };
                rq.data.trkpt.push(newPoint);//分段数据

            }
            rq.data.summary.name = 'fit';//运动标题
            // 转换"2024-11-23T07:01:13.000Z"
            //let timeStr = fit.metadata.time;
            let timeStr = fit.records[0].timestamp;
            let date = new Date(timeStr);
            let formattedTime = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}:${date.getSeconds().toString().padStart(2, '0')}`;
            rq.data.summary.training_at = formattedTime; // 训练时间
            rq.data.summary.total_time = sec; //训练时长
            rq.data.summary.total_timer_time = sec; //训练时长
            rq.data.motion.distance = parseFloat(distanceCurrent.toFixed(2));//训练路程
            rq.data.motion.total_ascent = parseFloat((total_ascent * 1000).toFixed(2));//总爬升
            rq.data.motion.total_descent = parseFloat((total_descent * 1000).toFixed(2));//总下降
            //计算每km用时
            // 假设rq对象已经定义好了，并且包含了所需的属性
            // 初始化变量
            let previousDistance = 0;
            let previousTimestamp = rq.data.trkpt.length > 0 ? rq.data.trkpt[0].timestamp : 0;
            let lapId = 0;
            // 遍历所有轨迹点
            for (let i = 0; i < rq.data.trkpt.length; i++) {
                let currentDistance = rq.data.trkpt[i].distance;
                let currentTimestamp = rq.data.trkpt[i].timestamp;
                // 计算距离差
                let distanceDiff = currentDistance - previousDistance;
                // 当距离差达到或超过1000米时，计算用时并存储
                while (distanceDiff >= 1000) {
                    // 计算用时（秒）
                    let totalTimerTime = currentTimestamp - previousTimestamp;
                    // 存储用时到lap_standard数组
                    rq.data.lap_standard.push({
                        id: lapId,
                        total_timer_time: totalTimerTime
                    });
                    // 更新变量
                    previousDistance += 1000;
                    previousTimestamp = currentTimestamp;
                    lapId++;
                    // 更新距离差
                    distanceDiff = currentDistance - previousDistance;
                }
            }
            // 注意：如果最后一个轨迹点的累计距离不是1000的整数倍，可能需要处理剩余的部分
            // 这里假设最后一个轨迹点已经处理过了，如果需要处理，可以添加相应的逻辑
            console.log(rq);

            return rq; // 返回解析后的gpx对象，假设它已经被转换为JSON兼容格式
        }

        // 赋值进度条到指定进度
        function setProgressBarValue(value) {
            var progressBar = document.getElementById('progressBar');
            progressBar.value = value;
            upFrame(value);
            daohang(value);
        }

        // 监听进度条变化事件
        document.getElementById('progressBar').addEventListener('input', function () {
            var currentValue = this.value;
            upFrame(currentValue);
            daohang(currentValue);
        });

        //获取当前进度条的值，并调用 upFrame 和 daohang
        function getProgressBarValueAndUpdate() {
            var progressBar = document.getElementById('progressBar');
            var currentValue = progressBar.value;
            upFrame(currentValue);
            daohang(currentValue);
        }



        //雷达图
        function to_leida_xy(count, speed, cadence) {
            // 定义雷达图的中心点
            const centerX = el_leida_pan.children[3].x;
            const centerY = el_leida_pan.children[3].y;
            // 定义雷达图的半径
            const radius = el_leida_pan.children[3].width;
            // 定义每个指标对应的角度
            const angles = [-210, -90, 30];
            // 定义每个指标的最大值
            const maxValues = [200, 22, 240];
            // 存储每个指标在雷达图上的点位置的数组
            let flatPoints = [];

            // 将角度转换为弧度，并计算每个指标在雷达图上的点位置
            angles.forEach((angle, index) => {
                // 计算指标值与最大值的比例
                const value = index === 0 ? count : (index === 1 ? speed : cadence);
                const proportion = value / maxValues[index];
                // 将角度转换为弧度
                const radians = angle * Math.PI / 180;
                // 计算雷达图上的点位置
                const x = centerX + radius * proportion * Math.cos(radians);
                const y = centerY + radius * proportion * Math.sin(radians);
                // 将点位置添加到数组中
                flatPoints.push(x, y);
            });

            // 返回扁平化的点位置数组
            return flatPoints;
        }

        // 更新frame_delay变量的值
        function updateFrameDelay(value) {
            // 更新frame_delay变量的值
            frame_delay = parseInt(value);
            // 可以在这里添加其他需要执行的代码，例如更新页面显示或调用其他函数
            console.log("frame_delay updated to: " + frame_delay);
        }

        //插值到1秒
        function interpolationPoints(data) {
            if (!data.data || !data.data.trkpt) {
                return;
            }

            let trkpt = data.data.trkpt;
            let i = 0;
            while (i < trkpt.length - 1) {
                let current = trkpt[i];
                let nextPoint = trkpt[i + 1];

                if (nextPoint.sec !== current.sec + 1) {
                    let targetSec = current.sec + 1;
                    let interpolatedPoint = {};

                    ["timestamp", "position_lat", "position_long", "altitude", "speed", "distance", "heart_rate", "cadence", "step_length"].forEach(key => {
                        if (current.hasOwnProperty(key) && nextPoint.hasOwnProperty(key)) {
                            let interpolatedValue = current[key] + (nextPoint[key] - current[key]) * (targetSec - current.sec) / (nextPoint.sec - current.sec);

                            // 根据属性类型进行格式化
                            if (key === "cadence" || key === "heart_rate") {
                                interpolatedPoint[key] = Math.round(interpolatedValue); // 取整
                            } else if (["distance", "speed", "step_length", "altitude"].includes(key)) {
                                interpolatedPoint[key] = parseFloat(interpolatedValue.toFixed(2)); // 保留两位小数
                            } else if (["position_lat", "position_long"].includes(key)) {
                                interpolatedPoint[key] = parseFloat(interpolatedValue.toFixed(6)); // 保留6位小数
                            } else {
                                interpolatedPoint[key] = interpolatedValue;
                            }
                        }
                    });

                    interpolatedPoint.sec = targetSec;
                    trkpt.splice(i + 1, 0, interpolatedPoint);
                }
                i++;
            }

            data.data.trkpt = trkpt;
        }

    </script>
    <script>
        layui.use(function () {
            var element = layui.element;
            // 绑定自定义的 tab 元素
            element.tab({
                headerElem: '#tabHeader>.tab',
                bodyElem: '#tabBody>div'
            });

            var $ = layui.$;
            var layer = layui.layer;
            // 绑定点击事件到具有 'layui-anim' 类的元素
            $('.layui-anim').on('click', function () {
                // 获取当前点击元素的 'lay-active' 属性值
                var layActiveValue = $(this).attr('lay-active');
                var selector = '#' + layActiveValue;
                // 在 frame 内查找对应元素
                var find = frame.find(selector);
                if (find.length == 0) {
                    frame.add(window[layActiveValue]);

                    $('#progressBar').val(parseInt(maxFrame * 0.7));
                    upFrame(parseInt(maxFrame * 0.7));

                } else {
                    alert(`${i18n.get('Object_already_exists')}`);
                }
            });

            // 保存按钮逻辑（使用事件委托）
            $(document).on('click', '#saveTemplate', function () {
                layui.layer.prompt({
                    title: 'saveTemplate',
                    value: 'User_Template', // 默认值
                    formType: 0 // 输入框类型，0 为文本输入
                }, function (value, index) {
                    // 调用保存函数
                    saveFrameConfigToLocalStorage(frame, value);
                    layui.layer.close(index); // 关闭弹层
                });
            });

            // 读取配置按钮逻辑（使用事件委托）
            $(document).on('click', '#loadTemplate', function () {
                // 获取所有配置
                const allConfigs = loadAllFrameConfigsFromLocalStorage();

                // 构建表格内容
                let tableHtml = `
                    <table class="layui-table">
                        <thead>
                            <tr>
                                <th>标题</th>
                                <th>保存时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>`;

                allConfigs.forEach(config => {
                    tableHtml += `
                        <tr>
                            <td>${config.title}</td>
                            <td>${config.isCustomTitle ? '自定义' : config.title}</td>
                            <td><button class="layui-btn layui-btn-sm loadConfig" data-config='${JSON.stringify(config.config)}'>载入</button></td>
                        </tr>`;
                });

                tableHtml += `</tbody></table>`;

                // 弹出层显示表格
                layui.layer.open({
                    type: 1,
                    title: '选择配置',
                    content: tableHtml,
                    area: ['600px', '400px'],
                    btn: ['关闭'],
                    yes: function (index) {
                        layui.layer.close(index); // 关闭弹层
                    }
                });

                // 绑定载入按钮点击事件（使用事件委托）
                $(document).on('click', '.loadConfig', function () {
                    try {
                        // 1. 获取原始属性值
                        const rawData = $(this).attr('data-config');
                        //console.log("原始 data-config:", rawData); // 调试输出
                        // 2. 替换 HTML 实体 &quot; 为双引号
                        const jsonString = rawData.replace(/&quot;/g, '"');
                        //console.log("处理后的 JSON 字符串:", jsonString); // 调试输出
                        // 3. 解析 JSON
                        const config = JSON.parse(jsonString);
                        //console.log("解析后的配置对象:", config); // 调试输出
                        // 4. 调用载入函数
                        load_user_tmp(config);
                        layui.layer.closeAll();
                    } catch (e) {
                        //console.error("解析配置失败:", e);
                        layui.layer.msg('配置解析失败，请检查数据格式。', { icon: 2 });
                    }
                });
            });

            var util = layui.util;
            var form = layui.form;
            // 事件
            util.on('lay-on', {
                'onmp4-page': function () {
                    layer.open({
                        type: 1,
                        area: ['720px', '860px'], // 宽高
                        title: `${i18n.get('Preview')}`,
                        content: `
                            <div class="view">
                                <div class="view_info" id="view_info"></div>
                                <video id="video" width="720px" height="720px" controls autoplay></video>
                                <div class="download_button" style="width: 380px;">
                                    ${i18n.get('download_movie')}
                                    <a id="download" download="movie.mp4">
                                    <button type="button" class="layui-btn layui-bg-blue layui-btn-fluid">download </button></a>
                                </div>
                            </div>
                        `
                    });
                },
                'setup': function () {
                    // 页面层
                    layer.open({
                        type: 1,
                        area: ['420px', '240px'], // 宽高
                        title: `${i18n.get('Setup')}`,
                        content: `
                            <div style="padding: 11px;">
                                <!-- 数字选择器 -->
                                ${i18n.get('Setup-ps')}<br>
                                <label for="frameDelayInput">${i18n.get('Setup-label-ps')}</label>
                                <input type="number" id="frameDelayInput" name="frameDelay"
                                    min="15" max="200" step="5" value="20"
                                    onchange="updateFrameDelay(this.value)">
                            </div>
                        `
                    });
                    frameDelayInput.value = frame_delay;
                },
            })
        });
    </script>
    <script>
        // maptalks地图
        var map = new maptalks.Map('leafletmap', {
            center: [118.9, 33.8], // 初始中心点
            zoom: 15, // 初始缩放级别
            baseLayer: new maptalks.TileLayer('base', {
                urlTemplate: 'https://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png',
                subdomains: ['a', 'b', 'c'],
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://hot.openstreetmap.org/">Humanitarian OpenStreetMap Team</a>'
            })
            // baseLayer: new maptalks.TileLayer('base', {
            //     urlTemplate: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
            //     subdomains: ['a', 'b', 'c', 'd'],
            //     attribution: '&copy; <a href="http://osm.org">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/">CARTO</a>'
            // })
        });

        var minimap = new maptalks.Map('leafletmap_mini', {
            center: [118.9, 33.8], // 初始中心点
            zoom: 17, // 初始缩放级别
            baseLayer: new maptalks.TileLayer('base', {
                urlTemplate: 'https://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png',
                subdomains: ['a', 'b', 'c'],
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://hot.openstreetmap.org/">Humanitarian OpenStreetMap Team</a>'
            })
        });

        var latlngs = [
            [119.1, 33.1],
            [119.2, 33.2],
            [119.1, 33.5]
        ];

        // 创建折线实例
        var polyline = new maptalks.LineString(latlngs, {
            symbol: {
                'lineColor': '#FFFF00',
                'lineWidth': 5,
                'lineOpacity': 0.9
            }
        });

        // 创建折线实例
        var mini_polyline = new maptalks.LineString(latlngs, {
            symbol: {
                'lineColor': '#FFFF00',
                'lineWidth': 5,
                'lineOpacity': 0.9
            }
        });

        // 创建折线实例
        var new_polyline = new maptalks.LineString([], {
            symbol: {
                'lineColor': '#FF8C00',
                'lineWidth': 5,
                'lineOpacity': 0.9
            }
        });
        // 创建折线实例
        var mini_new_polyline = new maptalks.LineString([], {
            symbol: {
                'lineColor': '#FF8C00',
                'lineWidth': 5,
                'lineOpacity': 0.9
            }
        });




        // red circle
        var marker = new maptalks.Marker(latlngs[0], {
            symbol:
            {
                'markerType': 'ellipse',
                'markerFill': '#FF6347',
                'markerFillOpacity': 0.9,
                'markerLineWidth': 0,
                'markerWidth': 15,
                'markerHeight': 15
            }

        });

        var mini_marker = new maptalks.Marker(latlngs[0], {
            symbol:
            {
                'markerType': 'ellipse',
                'markerFill': '#FF6347',
                'markerFillOpacity': 0.9,
                'markerLineWidth': 0,
                'markerWidth': 15,
                'markerHeight': 15
            }

        });





        var layer = new maptalks.VectorLayer('vector').addTo(map);
        var minilayer = new maptalks.VectorLayer('vector').addTo(minimap);

        // 将折线添加到地图上
        layer.addGeometry(polyline, new_polyline, marker);
        minilayer.addGeometry(mini_polyline, mini_new_polyline, mini_marker);
        // 调整视野到折线范围
        map.fitExtent(polyline.getExtent(), -0.125);
        minimap.fitExtent(mini_polyline.getExtent(), 16);
        minimap.setPitch(40);


        function set_leafletmap_latlngs(rqjson) {
            // 清空现有的latlngs数组
            latlngs.length = 0;

            // 遍历rqjson.data.trkpt数组
            for (var i = 0; i < rqjson.data.trkpt.length; i++) {
                // 获取每个点的纬度和经度
                var lat = rqjson.data.trkpt[i].position_lat;
                var lng = rqjson.data.trkpt[i].position_long;

                // 注意：maptalks的经纬度顺序是先经度后纬度
                latlngs.push([lng, lat]);
            }

            // 更新折线
            polyline.setCoordinates(latlngs);
            mini_polyline.setCoordinates(latlngs);
            // 重新调整视野到折线范围
            map.fitExtent(polyline.getExtent(), -0.125);
            minimap.setCenterAndZoom(latlngs[0], 16)
            //minimap.fitExtent(mini_polyline.getExtent());
        }


        function daohang(index) {
            // 检查下标是否在latlngs数组的有效范围内
            if (index < 0 || index >= latlngs.length) {
                console.error('下标超出范围');
                return;
            }

            // 获取指定下标的经纬度
            var coordinates = latlngs[index];

            // 移动标记到新的位置
            marker.setCoordinates(coordinates);
            mini_marker.setCoordinates(coordinates);

            // 更新折线，只包含从开始到当前index的点
            var polylineCoordinates = latlngs.slice(0, index * 1 + 1);
            new_polyline.setCoordinates(polylineCoordinates);
            mini_new_polyline.setCoordinates(polylineCoordinates);

            // 如果需要，可以调整地图视野到标记位置
            //map.panTo(coordinates);
            minimap.setCenter(coordinates);
        }


        // Export map to an image
        // External image(tiles, marker images) hosts need to support CORS
        function save() {
            var data = map.toDataURL({
                'mimeType': 'image/jpeg', // or 'image/png'
                'save': true,             // to pop a save dialog
                'fileName': 'map'         // file name
            });
        }

        function map_images() {
            //web_map_pan.children[0].url = map.toDataURL();
            return map.toDataURL();
        }

        function minimap_images() {
            return minimap.toDataURL();
        }



    </script>
    <script>


        // 函数用于加载用户模板
        function load_user_tmp(json) {
            // 检查 json.children 是否存在且有成员
            if (json.children && Array.isArray(json.children) && json.children.length > 0) {
                json.children.forEach(child => {
                    // 获取 id 值
                    if (child.id) {

                        const idValue = child.id;
                        console.log(idValue);
                        // 假设 idValue 是系统内已存在的变量名
                        if (window[idValue]) {
                            const variable = window[idValue];
                            console.log(variable);

                            // 将变量添加到 frame 中
                            frame.add(variable);

                            if (child.width !== undefined && variable.resizeWidth) {
                                variable.resizeWidth(child.width);
                            }



                            // 赋值 x, y, width
                            if (child.x !== undefined) {
                                variable.x = child.x;
                            }
                            if (child.y !== undefined) {
                                variable.y = child.y;
                            }
                            if (child.rotation !== undefined) {
                                variable.rotation = child.rotation;
                            }


                            // 遍历 children 处理 fill 和 stroke 属性
                            if (child.children && Array.isArray(child.children)) {
                                child.children.forEach((subChild, index) => {
                                    // 假设 variable.children 是一个数组，且顺序与 child.children 一致
                                    if (variable.children && Array.isArray(variable.children) && variable.children[index]) {
                                        const subVariable = variable.children[index];

                                        // 赋值 fill 和 stroke 属性
                                        if (subChild.fill !== undefined) {
                                            subVariable.fill = subChild.fill;
                                        }
                                        if (subChild.stroke !== undefined) {
                                            subVariable.stroke = subChild.stroke;
                                        }
                                        if (subChild.width !== undefined) {
                                            subVariable.width = subChild.width;
                                        }
                                        if (subChild.height !== undefined) {
                                            subVariable.height = subChild.height;
                                        }
                                        if (subChild.offsetX !== undefined) {
                                            subVariable.offsetX = subChild.offsetX;
                                        }
                                        if (subChild.offsetY !== undefined) {
                                            subVariable.offsetY = subChild.offsetY;
                                        }
                                        if (subChild.fontSize !== undefined) {
                                            subVariable.fontSize = subChild.fontSize;
                                        }



                                    } else {
                                        console.warn(`Sub-child at index ${index} not found in variable.children.`);
                                    }
                                });
                            }


                        } else {
                            console.warn(`Variable ${idValue} not found in global scope.`);
                        }
                    } else {
                        console.warn("No 'id' found in child.");
                    }
                });
            } else {
                console.warn("No children found in json.");
            }

            return frame;
        }

        //导出用户配置模板
        function exportFrameConfig(frame) {
            // 定义需要保留的字段
            const allowedFields = new Set([
                'tag', 'children', 'id', 'x', 'y', 'width', 'height',
                'rotation', 'fill', 'stroke', 'strokeWidth', 'offsetX',
                'offsetY', 'fontSize'
            ]);

            // 递归函数，提取指定字段
            function extractFields(obj) {
                if (typeof obj !== 'object' || obj === null) {
                    return obj; // 如果是基本类型，直接返回
                }

                // 创建一个新对象，只保留需要的字段
                const result = {};
                for (const key in obj) {
                    if (allowedFields.has(key)) {
                        result[key] = obj[key];
                    }
                }

                // 递归处理 children
                if (Array.isArray(obj.children)) {
                    result.children = obj.children.map(child => extractFields(child));
                }

                return result;
            }

            // 调用递归函数并返回结果
            return extractFields(frame);
        }

        //将用户配置保存到localStorage
        function saveFrameConfigToLocalStorage(frame, title = null) {
            // 导出 JSON 对象
            const exportedConfig = exportFrameConfig(frame);

            // 生成标题
            const configTitle = title || new Date().toLocaleString(); // 如果没有传入标题，则使用当前时间

            // 添加标志前缀
            const storageKey = `frameConfig_${configTitle}`;

            // 获取所有已保存的配置
            const allConfigs = loadAllFrameConfigsFromLocalStorage();

            // 检查是否超过 20 个配置
            if (allConfigs.length >= 20 && !title) {
                // 找到最早的默认标题配置
                const defaultConfigs = allConfigs.filter(config => !config.isCustomTitle);
                if (defaultConfigs.length > 0) {
                    // 按时间排序，找到最早的配置
                    defaultConfigs.sort((a, b) => new Date(a.title) - new Date(b.title));
                    const oldestConfig = defaultConfigs[0];

                    // 删除最早的配置
                    localStorage.removeItem(`frameConfig_${oldestConfig.title}`);
                    console.log(`Oldest configuration "${oldestConfig.title}" deleted.`);
                }
            }

            // 保存新配置
            localStorage.setItem(storageKey, JSON.stringify(exportedConfig));
            console.log(`Configuration saved to localStorage with key: "${storageKey}"`);
        }

        // 获取所有localStorage配置（带标志和标题类型）
        function loadAllFrameConfigsFromLocalStorage() {
            const configs = [];

            // 遍历 localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);

                // 检查键是否以标志前缀开头
                if (key.startsWith("frameConfig_")) {
                    const configString = localStorage.getItem(key);
                    if (configString) {
                        const config = JSON.parse(configString);
                        const title = key.replace("frameConfig_", "");

                        // 判断是否为自定义标题
                        const isCustomTitle = !isTimestampTitle(title);

                        configs.push({
                            title: title,
                            config: config,
                            isCustomTitle: isCustomTitle
                        });
                    }
                }
            }

            return configs;
        }

        // 判断标题是否为时间戳格式
        function isTimestampTitle(title) {
            // 简单判断是否为时间戳格式（如 "2023-10-05 14:30:00"）
            return /\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/.test(title);
        }



    </script>
</body>

</html>